local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

-- 1. åˆå§‹åŒ–è¿œç¨‹äº‹ä»¶
local pvpEvent = ReplicatedStorage:FindFirstChild("PvPEvent")
if not pvpEvent then
	pvpEvent = Instance.new("RemoteEvent")
	pvpEvent.Name = "PvPEvent"
	pvpEvent.Parent = ReplicatedStorage
end

local PvPManager = {}

-- ==========================================
-- è¾…åŠ©ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨åŒº
-- ==========================================
local function isInSafeZone(character)
	-- å¯»æ‰¾åœºæ™¯ä¸­çš„ SafeZone é›¶ä»¶
	local safeZonePart = Workspace:FindFirstChild("SafeZone")
	if not safeZonePart then return false end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then return false end

	-- ç©ºé—´æŸ¥è¯¢
	local partsInZone = Workspace:GetPartsInPart(safeZonePart)
	for _, part in pairs(partsInZone) do
		if part == rootPart then
			return true
		end
	end
	return false
end

-- ==========================================
-- æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ‡æ¢ PVP çŠ¶æ€
-- ==========================================
local function updatePvPStatus(player, isEnabled, reason)
	local char = player.Character
	if not char then return end

	-- 1. å¼€å¯æ—¶çš„å®‰å…¨åŒºæ£€æŸ¥ (é˜²æ­¢åœ¨å®‰å…¨åŒºå†…å¼€å¯)
	if isEnabled then
		if isInSafeZone(char) then
			pvpEvent:FireClient(player, "Error", "æ­¤ä¸ºå®‰å…¨åŒºï¼Œç¦æ­¢å¼€å¯PvP")
			return 
		end
	end

	-- 2. è®¾ç½®å±æ€§
	player:SetAttribute("PvPEnabled", isEnabled)

	-- 3. è§†è§‰åé¦ˆ
	local oldHighlight = char:FindFirstChild("PvP_Highlight")
	if oldHighlight then oldHighlight:Destroy() end

	if isEnabled then
		local highlight = Instance.new("Highlight")
		highlight.Name = "PvP_Highlight"
		highlight.Adornee = char
		highlight.FillTransparency = 1 
		highlight.OutlineColor = Color3.fromRGB(255, 0, 0) -- çº¢è‰²è½®å»“
		highlight.OutlineTransparency = 0
		highlight.Parent = char

		-- å¤´é¡¶åå­—æç¤º
		local humanoid = char:FindFirstChild("Humanoid")
		if humanoid then humanoid.DisplayName = "âš”ï¸ " .. player.Name end
	else
		-- æ¢å¤åå­—
		local humanoid = char:FindFirstChild("Humanoid")
		if humanoid then humanoid.DisplayName = player.Name end
	end

	-- 4. é€šçŸ¥å®¢æˆ·ç«¯æ›´æ–° UI
	pvpEvent:FireClient(player, "UpdateState", isEnabled)

	-- å¦‚æœæœ‰é¢å¤–åŸå› ï¼ˆæ¯”å¦‚è¢«å¼ºåˆ¶å…³é—­ï¼‰ï¼Œå¯ä»¥å‘ä¸ªæç¤º
	if reason then
		pvpEvent:FireClient(player, "Error", reason)
	end

	print(player.Name .. (isEnabled and " å¼€å¯äº† PVP" or " å…³é—­äº† PVP"))
end

-- ==========================================
-- [æ–°å¢] è‡ªåŠ¨æ£€æµ‹å¾ªç¯ï¼šè¿›å…¥å®‰å…¨åŒºå¼ºåˆ¶å…³é—­
-- ==========================================
task.spawn(function()
	while true do
		task.wait(0.5) -- æ¯ 0.5 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæ€§èƒ½æ¶ˆè€—å¾ˆä½

		for _, player in pairs(Players:GetPlayers()) do
			-- åªæ£€æŸ¥å½“å‰å¼€å¯äº† PvP çš„ç©å®¶
			if player:GetAttribute("PvPEnabled") then
				local char = player.Character
				if char and isInSafeZone(char) then
					-- å¼ºåˆ¶å…³é—­
					print("ğŸ›¡ï¸ [å®‰å…¨åŒº] å¼ºåˆ¶å…³é—­ " .. player.Name .. " çš„ PvP æ¨¡å¼")
					updatePvPStatus(player, false, "è¿›å…¥å®‰å…¨åŒºï¼ŒPvPå·²è‡ªåŠ¨å…³é—­")
				end
			end
		end
	end
end)

-- ==========================================
-- äº‹ä»¶ç›‘å¬
-- ==========================================
pvpEvent.OnServerEvent:Connect(function(player, action)
	if action == "TogglePvP" then
		local currentState = player:GetAttribute("PvPEnabled") or false
		updatePvPStatus(player, not currentState)
	end
end)

Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function()
		updatePvPStatus(player, false)
	end)
end)

return PvPManager