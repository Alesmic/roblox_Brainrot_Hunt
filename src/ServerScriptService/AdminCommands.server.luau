local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Require GameConfig for correct health calculation on level-up
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- ğŸ‘‘ ç®¡ç†å‘˜åˆ—è¡¨ (å¯é€‰ï¼šå¦‚æœä½ åªæƒ³è®©è‡ªå·±èƒ½ç”¨ï¼Œå¡«å…¥ UserID)
local ADMINS = {
	-- 12345678, -- æ›¿æ¢ä¸ºä½ çš„ UserId
}

-- ç®€å•çš„æƒé™æ£€æŸ¥å‡½æ•°
local function isAdmin(player)
	-- ç›®å‰é»˜è®¤å…è®¸æ‰€æœ‰äººä½¿ç”¨æ–¹ä¾¿æµ‹è¯•
	-- å¦‚æœéœ€è¦å¼€å¯æƒé™ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šå¹¶æŠŠ true æ”¹ä¸º false
	-- for _, id in pairs(ADMINS) do if player.UserId == id then return true end end
	return true 
end

-- ==========================================
-- ğŸ› ï¸ æ•°æ®æ“¦é™¤é€»è¾‘ (åŸ /reset é€»è¾‘ï¼Œç°æ”¹åä¸º /wipe)
-- ==========================================
local function wipePlayerData(targetPlayer)
	print("âš ï¸ [Admin] æ­£åœ¨æ“¦é™¤ç©å®¶æ•°æ®: " .. targetPlayer.Name)

	-- 1. é‡ç½®åŸºç¡€å±æ€§ (Level, Gold, Experience)
	local leaderstats = targetPlayer:FindFirstChild("leaderstats")
	if leaderstats then
		if leaderstats:FindFirstChild("Level") then 
			leaderstats.Level.Value = GameConfig.DefaultPlayer.Level or 1 
		end
		if leaderstats:FindFirstChild("Gold") then 
			leaderstats.Gold.Value = GameConfig.DefaultPlayer.Gold or 0 
		end
		if leaderstats:FindFirstChild("Experience") then
			leaderstats.Experience.Value = GameConfig.DefaultPlayer.Experience or 0
		end
	end

	-- 2. é‡ç½®éšè—å±æ€§ (æ•™ç¨‹çŠ¶æ€, ä»»åŠ¡)
	local hiddenStats = targetPlayer:FindFirstChild("HiddenStats")
	if hiddenStats then
		-- é‡ç½®æ•™ç¨‹çŠ¶æ€
		if hiddenStats:FindFirstChild("TutorialCompleted") then
			hiddenStats.TutorialCompleted.Value = false
			print("    ğŸ“˜ æ•™ç¨‹çŠ¶æ€å·²é‡ç½®")
		end

		-- åˆ é™¤æ‰€æœ‰ä»»åŠ¡
		for _, child in pairs(hiddenStats:GetChildren()) do
			if string.find(child.Name, "Quest") then
				child:Destroy()
				print("    ğŸ—‘ï¸ å·²ç§»é™¤ä»»åŠ¡: " .. child.Name)
			end
		end
	end

	-- 3. æ¸…ç©ºèƒŒåŒ…æ•°æ®
	local inventory = targetPlayer:FindFirstChild("Inventory")
	if inventory then
		inventory:ClearAllChildren()
		print("    ğŸ’ èƒŒåŒ…æ•°æ®å·²æ¸…ç©º")
	end

	-- 4. æ¸…ç©ºå®ä½“é“å…·
	targetPlayer.Backpack:ClearAllChildren()
	targetPlayer.StarterGear:ClearAllChildren()

	-- 5. é‡ç”Ÿ
	if targetPlayer.Character then
		local humanoid = targetPlayer.Character:FindFirstChild("Humanoid")
		if humanoid then
			humanoid.Health = 0 
		end
	end

	print("âœ… " .. targetPlayer.Name .. " çš„æ•°æ®å·²æ“¦é™¤ï¼")
end

-- ==========================================
-- ğŸ”„ è§’è‰²é‡ç½®é€»è¾‘ (æ–°ç‰ˆ /reset - ä»…é‡ç”Ÿï¼Œä¸åˆ æ•°æ®)
-- ==========================================
local function resetCharacter(targetPlayer)
	if targetPlayer.Character then
		local humanoid = targetPlayer.Character:FindFirstChild("Humanoid")
		if humanoid then
			humanoid.Health = 0 -- ä»…èµæ­»ç©å®¶ï¼Œè§¦å‘é‡ç”Ÿæµç¨‹
			print("ğŸ”„ [Admin] ç©å®¶å·²é‡ç½® (ä½ç½®/çŠ¶æ€): " .. targetPlayer.Name)
		end
	else
		targetPlayer:LoadCharacter() -- å¦‚æœæ²¡æœ‰è§’è‰²ï¼Œå¼ºåˆ¶åŠ è½½
		print("ğŸ”„ [Admin] ç©å®¶å·²é‡æ–°åŠ è½½: " .. targetPlayer.Name)
	end
end


-- Listen for players joining
Players.PlayerAdded:Connect(function(player)

	-- Listen for player chat messages
	player.Chatted:Connect(function(message)
		-- æƒé™æ£€æŸ¥
		if not isAdmin(player) then return end

		-- Split the message
		local args = string.split(message, " ")
		local command = string.lower(args[1]) 
		local value = tonumber(args[2])      

		local leaderstats = player:FindFirstChild("leaderstats")
		if not leaderstats then return end

		-- ============================
		-- Command 0: Reset Character (/reset) [å·²ä¿®æ”¹]
		-- ============================
		if command == "/reset" then
			-- ç°åœ¨åªé‡ç½®è§’è‰²ï¼Œä¸æ“¦é™¤æ•°æ®
			resetCharacter(player)
		end

		-- é‡ç½®æŒ‡å®šç©å®¶: /resetplayer æˆ– /resetall
		if command == "/resetplayer" or command == "/resetall" then
			local targetName = args[2]
			if targetName then
				local target = Players:FindFirstChild(targetName)
				if target then
					resetCharacter(target)
				else
					print("âŒ æ‰¾ä¸åˆ°ç©å®¶: " .. targetName)
				end
			else
				resetCharacter(player)
			end
		end

		-- ============================
		-- Command: Wipe Data (/wipe) [æ–°å¢ - ç”¨äºæµ‹è¯•åˆ æ¡£]
		-- ============================
		if command == "/wipe" then
			wipePlayerData(player)
		end

		-- ============================
		-- Command 1: Set Level (/lv or /level)
		-- ============================
		if (command == "/lv" or command == "/level") and value then
			local levelStat = leaderstats:FindFirstChild("Level")
			if levelStat then
				levelStat.Value = value
				print("âš™ï¸ Admin: Level set to " .. value)

				-- Recalculate health
				local character = player.Character
				local humanoid = character and character:FindFirstChild("Humanoid")

				if humanoid then
					local rewards = GameConfig.Leveling and GameConfig.Leveling.RewardsPerLevel or {HealthBonus = 10}
					local levelBonus = (value - 1) * rewards.HealthBonus
					local newMaxHealth = GameConfig.DefaultPlayer.MaxHealth + levelBonus

					humanoid.MaxHealth = newMaxHealth
					humanoid.Health = newMaxHealth
					print("    - Max Health updated to: " .. newMaxHealth)
				end
			end
		end

		-- ============================
		-- Command 2: Set Gold (/gold or /money)
		-- ============================
		if (command == "/gold" or command == "/money") and value then
			local goldStat = leaderstats:FindFirstChild("Gold")
			if goldStat then
				goldStat.Value = value
				print("âš™ï¸ Admin: Gold set to " .. value)
			end
		end

		-- ============================
		-- Command 3: Set Speed (/speed)
		-- ============================
		if command == "/speed" and value then
			local character = player.Character
			local humanoid = character and character:FindFirstChild("Humanoid")
			if humanoid then
				humanoid.WalkSpeed = value
				print("âš™ï¸ Admin: Speed set to " .. value)
			end
		end

		-- ============================
		-- Command 4: Give Item (/give ItemName)
		-- ============================
		if command == "/give" then
			local itemName = string.sub(message, 7)
			itemName = itemName:match("^%s*(.-)%s*$")

			local itemInfo = nil
			if GameConfig.Weapons then itemInfo = GameConfig.Weapons[itemName] end
			if not itemInfo and GameConfig.Items then itemInfo = GameConfig.Items[itemName] end
			if not itemInfo and GameConfig.Skin then itemInfo = GameConfig.Skin[itemName] end

			if itemInfo then
				local inventory = player:FindFirstChild("Inventory")
				if inventory then
					local itemValue = inventory:FindFirstChild(itemName)
					if not itemValue then
						itemValue = Instance.new("IntValue")
						itemValue.Name = itemName
						itemValue.Value = 0
						itemValue.Parent = inventory
					end
					itemValue.Value = itemValue.Value + 1

					if GameConfig.Weapons and GameConfig.Weapons[itemName] then
						local tool = game.ServerStorage.Tools:FindFirstChild(itemName)
						if tool then
							if not player.Backpack:FindFirstChild(itemName) then
								tool:Clone().Parent = player.Backpack
							end
							if not player.StarterGear:FindFirstChild(itemName) then
								tool:Clone().Parent = player.StarterGear
							end
						end
					end
					print("ğŸ Admin: Gave " .. itemName)
				end
			else
				warn("âŒ Item configuration not found: " .. itemName)
			end
		end

	end)
end)