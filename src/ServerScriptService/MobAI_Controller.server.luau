local ServerScriptService = game:GetService("ServerScriptService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

-- å¼•å…¥é…ç½®å’Œå¤„ç†æ¨¡å—
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))
-- å°è¯•å¼•ç”¨ MobHandlerï¼Œå¦‚æžœæ²¡æ‰¾åˆ°åˆ™ä¸æŠ¥é”™ï¼ˆå…¼å®¹æ€§ï¼‰
local MobHandler
pcall(function() 
	MobHandler = require(ServerScriptService:WaitForChild("MobHandler")) 
end)

local MobAI = {}
local ACTIVE_MOBS = {} -- å­˜å‚¨æ­£åœ¨è¿è¡Œçš„æ€ªç‰©

-- ==========================================
-- [æ–°å¢ž] è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨åŒº
-- ==========================================
local function isInSafeZone(character)
	local safeZonePart = Workspace:FindFirstChild("SafeZone")
	if not safeZonePart then return false end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then return false end

	-- ç©ºé—´æŸ¥è¯¢
	local partsInZone = Workspace:GetPartsInPart(safeZonePart)
	for _, part in pairs(partsInZone) do
		if part == rootPart then
			return true
		end
	end
	return false
end

-- ==========================================
-- AI æ ¸å¿ƒé€»è¾‘: å¯»æ‰¾æœ€è¿‘çš„çŽ©å®¶
-- ==========================================
local function findNearestPlayer(rootPart, range)
	local nearestPlr = nil
	local minDst = range or 20 -- é»˜è®¤ä¾¦æµ‹èŒƒå›´ 20

	for _, player in pairs(Players:GetPlayers()) do
		local char = player.Character
		if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
			local hum = char.Humanoid
			-- åˆ¤å®šæ¡ä»¶ï¼š
			-- 1. çŽ©å®¶æ´»ç€ (Health > 0)
			-- 2. çŽ©å®¶ä¸åœ¨å®‰å…¨åŒºå†… (not isInSafeZone) [å…³é”®ä¿®æ”¹]
			if hum.Health > 0 and not isInSafeZone(char) then
				local dst = (char.HumanoidRootPart.Position - rootPart.Position).Magnitude
				if dst < minDst then
					minDst = dst
					nearestPlr = char.HumanoidRootPart
				end
			end
		end
	end
	return nearestPlr
end

-- ==========================================
-- æ¿€æ´»å•ä¸ªæ€ªç‰©
-- ==========================================
function MobAI.initializeMob(mob)
	if ACTIVE_MOBS[mob] then return end -- é˜²æ­¢é‡å¤åˆå§‹åŒ–

	-- 1. éªŒè¯é…ç½®
	local config = GameConfig.Mobs[mob.Name]
	if not config then 
		-- print("   [AI] è·³è¿‡æ— å…³ NPC: " .. mob.Name) 
		return 
	end

	print("ðŸ¤– [AI] æŽ¥ç®¡æ€ªç‰©: " .. mob.Name)
	ACTIVE_MOBS[mob] = true

	-- 2. èŽ·å–å…³é”®éƒ¨ä»¶ (å…¼å®¹ R6 å’Œ R15)
	local humanoid = mob:WaitForChild("Humanoid", 5)
	local rootPart = mob:WaitForChild("HumanoidRootPart", 5) or mob:WaitForChild("Torso", 5)

	if not humanoid or not rootPart then
		warn("âŒ [AI] " .. mob.Name .. " ç¼ºå°‘ Humanoid æˆ– RootPartï¼Œæ— æ³•ç§»åŠ¨ï¼")
		return
	end

	-- 3. å¼ºåˆ¶åˆå§‹åŒ–å±žæ€§ (é˜²å¡æ­»)
	humanoid.WalkSpeed = config.WalkSpeed or 12
	humanoid.MaxHealth = config.MaxHealth
	humanoid.Health = config.MaxHealth

	-- ç¡®ä¿æ€ªç‰©ä¸è¢«å†»ç»“
	for _, part in pairs(mob:GetDescendants()) do
		if part:IsA("BasePart") then part.Anchored = false end
	end

	-- å¦‚æžœæœ‰ MobHandlerï¼Œè¿›è¡ŒæŽ‰è½/è¡€é‡è®¾ç½®
	if MobHandler and MobHandler.setupMob then
		MobHandler.setupMob(mob)
	end

	-- 4. å¯åŠ¨ AI å¾ªçŽ¯ (ä½¿ç”¨ task.spawn ç‹¬ç«‹è¿è¡Œ)
	task.spawn(function()
		while mob and mob.Parent do
			if humanoid.Health <= 0 then break end

			-- å¯»æ‰¾ç›®æ ‡ (ä¾¦æµ‹èŒƒå›´ 50)
			local target = findNearestPlayer(rootPart, 50) 

			if target then
				-- A. è¿½å‡»æ¨¡å¼
				humanoid:MoveTo(target.Position)

				-- æ”»å‡»åˆ¤æ–­
				local dist = (target.Position - rootPart.Position).Magnitude
				if dist <= (config.AttackRange or 5) then
					-- è¿™é‡Œå¯ä»¥æ’­æ”¾æ”»å‡»åŠ¨ç”»
					-- é€ æˆä¼¤å®³ (ç®€å•ç‰ˆ)
					if os.time() % (config.AttackSpeed or 1.5) < 0.1 then
						local targetHum = target.Parent:FindFirstChild("Humanoid")
						if targetHum then
							targetHum:TakeDamage(config.Damage)
						end
					end
				end
			else
				-- B. å·¡é€»æ¨¡å¼ (éšæœºèµ°åŠ¨) - å¯é€‰
				-- humanoid:MoveTo(rootPart.Position + Vector3.new(math.random(-10,10), 0, math.random(-10,10)))
			end

			task.wait(0.2) -- AI åˆ·æ–°é¢‘çŽ‡
		end
		ACTIVE_MOBS[mob] = nil
	end)
end

-- ==========================================
-- è‡ªåŠ¨æ‰«æç³»ç»Ÿ
-- ==========================================
local npcFolder = Workspace:WaitForChild("NPCs")

-- 1. æ‰«æçŽ°æœ‰æ€ªç‰©
for _, child in pairs(npcFolder:GetChildren()) do
	MobAI.initializeMob(child)
end

-- 2. ç›‘å¬æ–°ç”Ÿæˆçš„æ€ªç‰©
npcFolder.ChildAdded:Connect(function(child)
	MobAI.initializeMob(child)
end)

return MobAI