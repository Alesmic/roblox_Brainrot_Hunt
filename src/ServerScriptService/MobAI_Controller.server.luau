local ServerScriptService = game:GetService("ServerScriptService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

-- å¼•å…¥é…ç½®å’Œå¤„ç†æ¨¡å—
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))
local MobHandler
pcall(function() 
	MobHandler = require(ServerScriptService:WaitForChild("MobHandler")) 
end)

local MobAI = {}
local ACTIVE_MOBS = {} 

-- ==========================================
-- ðŸš« å¿½ç•¥åˆ—è¡¨ (åœ¨æ­¤æ·»åŠ ä¸å¸Œæœ› AI æŽ§åˆ¶çš„ NPC)
-- ==========================================
local IGNORE_LIST = {
	["Buyer/Seller"] = true,
	["SkinSeller"] = true,
	["Doctor"] = true,
	["Tung Tung Sahur"] = true,
	["Ring"] = true, -- åœºæ™¯ç‰©ä½“
	["SpawnPoint"] = true,
}

-- ==========================================
-- é…ç½®å‚æ•°
-- ==========================================
local ACTIVATION_DISTANCE = 50   -- è¿½å‡»èŒƒå›´
local ACTIVE_UPDATE_RATE = 0.2   -- è¿½å‡»åˆ·æ–°çŽ‡
local IDLE_UPDATE_RATE = 4.0     -- å·¡é€»åˆ·æ–°çŽ‡
local WANDER_RADIUS = 15         -- å·¡é€»èŒƒå›´

-- ==========================================
-- æ ¸å¿ƒä¿®å¤ï¼šèŽ·å–çœŸå®žçš„æ€ªç‰©åå­—
-- ==========================================
local function getRealMobName(model)
	-- 1. å¦‚æžœåå­—ç›´æŽ¥åœ¨é…ç½®é‡Œï¼Œç›´æŽ¥è¿”å›ž
	if GameConfig.Mobs[model.Name] then 
		return model.Name 
	end

	-- 2. å°è¯•å¤„ç†è¢«æ”¹åçš„ Boss
	-- ä¾‹å¦‚: "[Boss] Saharan Master (Lv. 300)..." -> æå– "Saharan Master"
	-- åŒ¹é…è§„åˆ™ï¼šæŸ¥æ‰¾ [Boss] å’Œ (Lv ä¹‹é—´çš„æ–‡å­—
	local cleanName = string.match(model.Name, "^%[Boss%]%s+(.-)%s+%(")
	if cleanName and GameConfig.Mobs[cleanName] then
		return cleanName
	end

	-- 3. è¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œè¿”å›ž nil
	return nil
end

-- ==========================================
-- è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨åŒºæ£€æµ‹
-- ==========================================
local function isInSafeZone(character)
	local safeZonePart = Workspace:FindFirstChild("SafeZone")
	if not safeZonePart then return false end

	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then return false end

	local partsInZone = Workspace:GetPartsInPart(safeZonePart)
	for _, part in pairs(partsInZone) do
		if part == rootPart then return true end
	end
	return false
end

-- ==========================================
-- å¯»æ‰¾æœ€è¿‘çŽ©å®¶
-- ==========================================
local function findNearestPlayer(rootPart, range)
	local nearestPlr = nil
	local minDst = range 

	for _, player in pairs(Players:GetPlayers()) do
		local char = player.Character
		if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
			local hum = char.Humanoid
			if hum.Health > 0 and not isInSafeZone(char) then
				local dst = (char.HumanoidRootPart.Position - rootPart.Position).Magnitude
				if dst < minDst then
					minDst = dst
					nearestPlr = char.HumanoidRootPart
				end
			end
		end
	end
	return nearestPlr
end

-- ==========================================
-- æ¿€æ´»æ€ªç‰©
-- ==========================================
function MobAI.initializeMob(mob)
	if ACTIVE_MOBS[mob] then return end 

	-- 1. [è¿‡æ»¤] æ£€æŸ¥æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨
	if IGNORE_LIST[mob.Name] then return end

	-- 2. [è¿‡æ»¤] æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ç”Ÿç‰© (å¿…é¡»æœ‰ Humanoid)
	-- è¿™èƒ½è¿‡æ»¤æŽ‰åƒ 'Ring' è¿™æ ·çš„çº¯é›¶ä»¶
	local humanoid = mob:FindFirstChild("Humanoid")
	if not humanoid then return end 

	-- 3. [ä¿®å¤] èŽ·å–çœŸå®žåå­—å¹¶è¯»å–é…ç½®
	local realName = getRealMobName(mob)
	local config = realName and GameConfig.Mobs[realName]

	if not config then 
		-- åªæœ‰å½“å®ƒçœ‹èµ·æ¥åƒä¸ªæ€ª(æœ‰Humanoid)ä½†æ²¡é…ç½®æ—¶æ‰è­¦å‘Š
		warn("âš ï¸ [AI] è·³è¿‡: '" .. mob.Name .. "' (æœªåœ¨ GameConfig æ‰¾åˆ°é…ç½®ï¼Œæˆ–åå­—è¢«ä¿®æ”¹)")
		return 
	end

	ACTIVE_MOBS[mob] = true
	-- print("ðŸ¤– [AI] å¯åŠ¨: " .. realName)

	-- 4. èŽ·å– RootPart
	local rootPart = mob:FindFirstChild("HumanoidRootPart") or mob:FindFirstChild("Torso")
	if not rootPart then return end

	-- 5. åˆå§‹åŒ–å±žæ€§
	humanoid.WalkSpeed = config.WalkSpeed or 12
	humanoid.MaxHealth = config.MaxHealth

	-- å¼ºåˆ¶è§£å†»
	for _, part in pairs(mob:GetDescendants()) do
		if part:IsA("BasePart") then part.Anchored = false end
	end

	pcall(function() rootPart:SetNetworkOwner(nil) end)

	if MobHandler and MobHandler.setupMob then
		-- æ³¨æ„ï¼šå¦‚æžœ MobHandler ä¹Ÿä¾èµ–åå­—ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œ
		-- ä½† setupMob é€šå¸¸åªä¾èµ– Humanoid è®¾ç½®è¡€é‡
		MobHandler.setupMob(mob)
	end

	-- 6. å¯åŠ¨å¾ªçŽ¯
	task.spawn(function()
		task.wait(math.random() * 2) 

		while mob and mob.Parent do
			if humanoid.Health <= 0 then break end

			local target = findNearestPlayer(rootPart, ACTIVATION_DISTANCE) 

			if target then
				-- [è¿½å‡»]
				humanoid:MoveTo(target.Position)
				local dist = (target.Position - rootPart.Position).Magnitude

				if dist <= (config.AttackRange or 5) then
					if os.time() % (config.AttackSpeed or 1.5) < 0.2 then
						local targetHum = target.Parent:FindFirstChild("Humanoid")
						if targetHum then
							targetHum:TakeDamage(config.Damage)
						end
					end
				end
				task.wait(ACTIVE_UPDATE_RATE)
			else
				-- [å·¡é€»]
				local randomOffset = Vector3.new(
					math.random(-WANDER_RADIUS, WANDER_RADIUS), 
					0, 
					math.random(-WANDER_RADIUS, WANDER_RADIUS)
				)
				humanoid:MoveTo(rootPart.Position + randomOffset)
				task.wait(IDLE_UPDATE_RATE)
			end
		end
		ACTIVE_MOBS[mob] = nil
	end)
end

-- ==========================================
-- è‡ªåŠ¨æ‰«æ
-- ==========================================
local npcFolder = Workspace:WaitForChild("NPCs")

for _, child in pairs(npcFolder:GetChildren()) do
	MobAI.initializeMob(child)
end

npcFolder.ChildAdded:Connect(function(child)
	MobAI.initializeMob(child)
end)

return MobAI