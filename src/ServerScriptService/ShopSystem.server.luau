local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")

-- 1. è·å–èµ„æº
-- [æ³¨æ„] æ”¹ä¸ºä» RemoteFunction æ–‡ä»¶å¤¹è·å–ï¼Œå› ä¸º InventorySystem å·²å°†å…¶å‡çº§
local RemoteFunctionFolder = ReplicatedStorage:WaitForChild("RemoteFunction") 
local buyItemFunc = RemoteFunctionFolder:WaitForChild("BuyItem") 

local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- 2. æ„å»º ProductID -> ItemName æŸ¥æ‰¾è¡¨
local ProductMap = {}
if GameConfig.Weapons then
	for name, data in pairs(GameConfig.Weapons) do
		if data.ProductId then ProductMap[data.ProductId] = name end
	end
end
if GameConfig.Items then
	for name, data in pairs(GameConfig.Items) do
		if data.ProductId then ProductMap[data.ProductId] = name end
	end
end
if GameConfig.Skin then
	for name, data in pairs(GameConfig.Skin) do
		if data.ProductId then ProductMap[data.ProductId] = name end
	end
end

-- ==========================================
-- A. å¤„ç† Robux è´­ä¹°
-- ==========================================
MarketplaceService.ProcessReceipt = function(receiptInfo)
	local playerId = receiptInfo.PlayerId
	local productId = receiptInfo.ProductId
	local player = Players:GetPlayerByUserId(playerId)

	if not player then return Enum.ProductPurchaseDecision.NotProcessedYet end

	local itemName = ProductMap[productId]

	if itemName then
		print("ğŸ’ [ShopSystem] ç©å®¶ Robux è´­ä¹°: " .. itemName)

		local itemConfig = GameConfig.Weapons[itemName] or GameConfig.Items[itemName] or GameConfig.Skin[itemName]
		local isWeapon = (itemConfig and itemConfig.Category == "Weapons")

		-- æ£€æŸ¥å”¯ä¸€æ€§
		if isWeapon then
			if player.Backpack:FindFirstChild(itemName) or player.StarterGear:FindFirstChild(itemName) then
				print("âš ï¸ ç©å®¶å·²æœ‰è¯¥æ­¦å™¨ï¼Œè·³è¿‡å‘æ”¾ã€‚")
				return Enum.ProductPurchaseDecision.PurchaseGranted
			end
		end

		-- å†™å…¥æ•°æ®
		local inventory = player:FindFirstChild("Inventory")
		if inventory then
			local itemVal = inventory:FindFirstChild(itemName) or Instance.new("IntValue", inventory)
			itemVal.Name = itemName
			if isWeapon then itemVal.Value = 1 else itemVal.Value = itemVal.Value + 1 end
		end

		-- å‘æ”¾é“å…·
		local tool = ServerStorage:FindFirstChild("Tools") and ServerStorage.Tools:FindFirstChild(itemName)
		if tool then
			if not player.Backpack:FindFirstChild(itemName) then tool:Clone().Parent = player.Backpack end
			if not player.StarterGear:FindFirstChild(itemName) then tool:Clone().Parent = player.StarterGear end
		end

		return Enum.ProductPurchaseDecision.PurchaseGranted
	end
	return Enum.ProductPurchaseDecision.PurchaseGranted
end

-- ==========================================
-- B. å¤„ç†é‡‘å¸è´­ä¹° (æ ¸å¿ƒä¿®å¤: ä½¿ç”¨ OnServerInvoke)
-- ==========================================
buyItemFunc.OnServerInvoke = function(player, itemName)
	print("ğŸ›’ [ShopSystem] æ”¶åˆ°è´­ä¹°è¯·æ±‚: " .. tostring(itemName))

	local itemInfo = GameConfig.Items[itemName] or GameConfig.Skin[itemName] or GameConfig.Weapons[itemName]
	if not itemInfo then return false end -- ç‰©å“ä¸å­˜åœ¨

	-- é˜²ä½œå¼Šï¼šç¦æ­¢é‡‘å¸ä¹° Robux ç‰©å“
	if itemInfo.ProductId then return false end

	local leaderstats = player:FindFirstChild("leaderstats")
	local goldStat = leaderstats and leaderstats:FindFirstChild("Gold")
	local inventory = player:FindFirstChild("Inventory")

	if not goldStat or not inventory then return false end

	-- æ£€æŸ¥é‡å¤æ­¦å™¨
	if itemInfo.Category == "Weapons" then
		local owned = inventory:FindFirstChild(itemName)
		if (owned and owned.Value >= 1) or player.StarterGear:FindFirstChild(itemName) then
			warn("âŒ ç©å®¶å·²æ‹¥æœ‰æ­¤æ­¦å™¨")
			return false -- è´­ä¹°å¤±è´¥
		end
	end

	local price = itemInfo.Price or 999999
	if goldStat.Value >= price then
		goldStat.Value = goldStat.Value - price

		-- æ›´æ–°åº“å­˜
		local itemValue = inventory:FindFirstChild(itemName) or Instance.new("IntValue", inventory)
		itemValue.Name = itemName

		if itemInfo.Category == "Weapons" then
			itemValue.Value = 1
		else
			itemValue.Value = itemValue.Value + 1
		end

		-- å‘æ”¾é“å…·
		local tool = ServerStorage:FindFirstChild("Tools") and ServerStorage.Tools:FindFirstChild(itemName)
		if tool then
			if not player.Backpack:FindFirstChild(itemName) then
				tool:Clone().Parent = player.Backpack
			end
			-- åªæœ‰æ­¦å™¨æ‰å­˜å…¥ StarterGearï¼Œæ¶ˆè€—å“ä¸å­˜
			if itemInfo.Category == "Weapons" then
				if not player.StarterGear:FindFirstChild(itemName) then
					tool:Clone().Parent = player.StarterGear
				end
			end
		end

		return true -- è´­ä¹°æˆåŠŸ
	end

	return false -- é‡‘å¸ä¸è¶³
end