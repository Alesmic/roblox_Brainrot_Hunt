local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

local MobHandler = {}

-- ==========================================
-- é…ç½®åŒº
-- ==========================================
local RESPAWN_TIME = 300       -- é»˜è®¤é‡ç”Ÿæ—¶é—´ (5åˆ†é’Ÿ)
local CORPSE_LIFETIME = 3      -- å°¸ä½“ä¿ç•™æ—¶é—´ (ç§’)

-- [æ–°å¢] Boss è¯†åˆ«å…³é”®è¯ (åå­—é‡Œå¸¦è¿™äº›çš„éƒ½ç®— Boss)
local BOSS_KEYWORDS = {"Boss", "Guardian", "Master"}

-- [æ–°å¢] Boss ç™½åå• (åå­—é‡Œæ²¡å…³é”®è¯ï¼Œä½†ä½ æƒ³ç®—ä½œ Boss çš„å¯ä»¥åŠ åœ¨è¿™é‡Œ)
local BOSS_WHITELIST = {
	["WolfBoss"] = true, -- ç¤ºä¾‹
	["DesertKing"] = true,
}

-- å­˜å‚¨æ€ªç‰©æ¨¡æ¿
local MobRegistry = {} 
local mobTemplateFolder = ServerStorage:FindFirstChild("MobTemplates")
if not mobTemplateFolder then
	mobTemplateFolder = Instance.new("Folder")
	mobTemplateFolder.Name = "MobTemplates"
	mobTemplateFolder.Parent = ServerStorage
end

-- è®°å½•é‡ç”Ÿæ—¶é—´
MobHandler.DeadBosses = {} 

function MobHandler.getRespawnTime(mobName)
	return MobHandler.DeadBosses[mobName]
end

-- ==========================================
-- è¾…åŠ©åŠŸèƒ½ï¼šåˆ¤æ–­æ˜¯å¦ä¸º Boss
-- ==========================================
local function isBoss(mobName)
	-- 1. æ£€æŸ¥ç™½åå•
	if BOSS_WHITELIST[mobName] then return true end

	-- 2. æ£€æŸ¥å…³é”®è¯åŒ¹é…
	for _, keyword in ipairs(BOSS_KEYWORDS) do
		if string.find(mobName, keyword) then
			return true
		end
	end

	return false
end

-- ==========================================
-- è¾…åŠ©åŠŸèƒ½ï¼šè§¦å‘å®¢æˆ·ç«¯å¼¹çª—
-- ==========================================
local function notifyClient(player, title, gold, exp)
	local RemoteEventFolder = ReplicatedStorage:FindFirstChild("RemoteEvent")
	if RemoteEventFolder then
		local notifyEvent = RemoteEventFolder:FindFirstChild("QuestCompleted")
		if notifyEvent then
			notifyEvent:FireClient(player, title, gold, exp)
		end
	end
end

-- ==========================================
-- è¾…åŠ©åŠŸèƒ½ï¼šç»™ç©å®¶å‘æ”¾ç‰©å“ (é˜²é‡å¤é€»è¾‘)
-- ==========================================
local function giveItemToPlayer(player, itemName)
	-- 1. è·å–ç‰©å“é…ç½®
	local itemConfig = GameConfig.Weapons[itemName] or GameConfig.Items[itemName]

	-- å¦‚æœæ˜¯æ­¦å™¨ï¼Œæ‰§è¡Œå”¯ä¸€æ€§æ£€æŸ¥
	if itemConfig and itemConfig.Category == "Weapons" then
		-- æ£€æŸ¥èƒŒåŒ…æˆ–åˆå§‹è£…å¤‡
		if player.Backpack:FindFirstChild(itemName) or player.StarterGear:FindFirstChild(itemName) then
			print("âš ï¸ [MobHandler] ç©å®¶å·²æœ‰æ­¦å™¨: " .. itemName .. "ï¼Œè·³è¿‡æ‰è½ã€‚")
			return false
		end

		-- æ£€æŸ¥æ•°æ®å±‚
		local inv = player:FindFirstChild("Inventory")
		if inv and inv:FindFirstChild(itemName) and inv[itemName].Value >= 1 then
			return false
		end
	end

	-- æŸ¥æ‰¾ç‰©å“æ¨¡å‹
	local tool = ServerStorage:FindFirstChild("Tools") and ServerStorage.Tools:FindFirstChild(itemName)
	if not tool then
		tool = ServerStorage:FindFirstChild("Items") and ServerStorage.Items:FindFirstChild(itemName)
	end

	if tool then
		-- å‘æ”¾åˆ°èƒŒåŒ…
		if not player.Backpack:FindFirstChild(itemName) then
			local clone = tool:Clone()
			clone.Parent = player.Backpack
		end

		-- å‘æ”¾åˆ° StarterGear (ç¡®ä¿é‡ç”Ÿä¸ä¸¢)
		if not player.StarterGear:FindFirstChild(itemName) then
			tool:Clone().Parent = player.StarterGear
		end

		-- æ›´æ–° Inventory æ•°æ®
		local inventory = player:FindFirstChild("Inventory")
		if inventory then
			local itemVal = inventory:FindFirstChild(itemName)
			if not itemVal then
				itemVal = Instance.new("IntValue")
				itemVal.Name = itemName
				itemVal.Value = 0
				itemVal.Parent = inventory
			end

			if itemConfig and itemConfig.Category == "Weapons" then
				itemVal.Value = 1
			else
				itemVal.Value = itemVal.Value + 1
			end
		end
		return true
	else
		warn("âŒ [MobHandler] Loot item '"..itemName.."' not found in ServerStorage!")
		return false
	end
end

-- ==========================================
-- æ ¸å¿ƒé€»è¾‘ï¼šæ€ªç‰©ç”Ÿå‘½å‘¨æœŸç®¡ç†
-- ==========================================
local function handleMobLifecycle(mob, originCFrame)
	local humanoid = mob:WaitForChild("Humanoid", 10)
	if not humanoid then return end

	-- ç›‘å¬æ­»äº¡
	humanoid.Died:Connect(function()
		print("ğŸ’€ [MobHandler] " .. mob.Name .. " has died")

		-- 1. è®°å½•æ­»äº¡æ—¶é—´
		MobHandler.DeadBosses[mob.Name] = os.time() + RESPAWN_TIME

		-- è·å–å‡»æ€è€…
		local creatorTag = humanoid:FindFirstChild("creator")
		local killerPlayer = creatorTag and creatorTag.Value

		if killerPlayer then
			print("    ğŸ—¡ï¸ Killer: " .. killerPlayer.Name)
			local mobConfig = GameConfig.Mobs[mob.Name]

			if mobConfig then
				-- A. ç»™äºˆç»éªŒ
				local leaderstats = killerPlayer:FindFirstChild("leaderstats")
				if leaderstats and leaderstats:FindFirstChild("Experience") then
					leaderstats.Experience.Value = leaderstats.Experience.Value + mobConfig.Exp
				end

				-- B. ç»™äºˆé‡‘å¸
				if leaderstats and leaderstats:FindFirstChild("Gold") and mobConfig.GoldReward then
					leaderstats.Gold.Value = leaderstats.Gold.Value + mobConfig.GoldReward
				end

				-- [ä¿®æ”¹] ä»…å½“æ˜¯ Boss æ—¶ï¼Œæ‰è§¦å‘å‡»æ€å¥–åŠ±å¼¹çª—
				if isBoss(mob.Name) then
					notifyClient(killerPlayer, "Defeated " .. mob.Name, mobConfig.GoldReward or 0, mobConfig.Exp)
				end

				-- C. æ›´æ–°ä»»åŠ¡è¿›åº¦
				local hiddenStats = killerPlayer:FindFirstChild("HiddenStats")
				if hiddenStats and GameConfig.Quests then
					for questID, questData in pairs(GameConfig.Quests) do
						if questData.TargetMob == mob.Name then
							local questStat = hiddenStats:FindFirstChild("Quest_" .. questID)

							if questStat and questStat.Value < questData.TargetCount then
								questStat.Value = questStat.Value + 1

								-- ä»»åŠ¡å®Œæˆé€»è¾‘
								if questStat.Value == questData.TargetCount then
									-- å‘æ”¾ä»»åŠ¡å¥–åŠ±
									if questData.GoldReward and leaderstats and leaderstats.Gold then
										leaderstats.Gold.Value = leaderstats.Gold.Value + questData.GoldReward
									end
									if questData.ExpReward and leaderstats and leaderstats.Experience then
										leaderstats.Experience.Value = leaderstats.Experience.Value + questData.ExpReward
									end

									-- [ä¿ç•™] ä»»åŠ¡å®Œæˆæ€»æ˜¯å¼¹çª—
									notifyClient(killerPlayer, "Completed: " .. questData.Name, questData.GoldReward, questData.ExpReward)
								end
							end
						end
					end
				end

				-- D. ç‰©å“æ‰è½
				if mobConfig.Drops then
					for _, dropData in pairs(mobConfig.Drops) do
						if math.random() <= dropData.Chance then
							local success = giveItemToPlayer(killerPlayer, dropData.ItemName)
							if success then
								print("    ğŸ Dropped item: " .. dropData.ItemName)
							end
						end
					end
				end
			end
		end

		-- 2. é€šçŸ¥ Boss æˆ¿é—´ç®¡ç†å™¨ (å¦‚æœå­˜åœ¨)
		local notifyEvent = ServerStorage:FindFirstChild("BossDeathNotify")
		if notifyEvent then
			notifyEvent:Fire(mob.Name)
		end

		-- 3. å°¸ä½“æ¸…ç†
		task.delay(CORPSE_LIFETIME, function()
			if mob and mob.Parent then mob:Destroy() end
		end)

		-- 4. å¯åŠ¨é‡ç”Ÿå€’è®¡æ—¶
		task.delay(RESPAWN_TIME, function()
			MobHandler.respawnMob(mob.Name, originCFrame)
		end)
	end)
end

-- ==========================================
-- é‡ç”Ÿä¸åˆå§‹åŒ–å‡½æ•°
-- ==========================================
function MobHandler.respawnMob(mobName, spawnCFrame)
	local template = MobRegistry[mobName]
	if template then
		MobHandler.DeadBosses[mobName] = nil -- æ¸…é™¤æ­»äº¡è®°å½•

		local newMob = template:Clone()
		newMob.Name = mobName
		local root = newMob:FindFirstChild("HumanoidRootPart") or newMob:FindFirstChild("Torso")
		if root then root.CFrame = spawnCFrame else newMob:PivotTo(spawnCFrame) end

		newMob.Parent = Workspace:WaitForChild("NPCs")

		handleMobLifecycle(newMob, spawnCFrame)
		MobHandler.setupMob(newMob)

		print("âœ¨ " .. mobName .. " has respawned!")
	end
end

function MobHandler.setupMob(mob)
	local config = GameConfig.Mobs[mob.Name]
	if not config then return end

	local humanoid = mob:WaitForChild("Humanoid", 10)
	if humanoid then
		humanoid.MaxHealth = config.MaxHealth
		humanoid.Health = config.MaxHealth
		humanoid.WalkSpeed = config.WalkSpeed or 12
	end
end

-- ==========================================
-- åˆå§‹åŒ–ï¼šæ‰«æç°æœ‰æ€ªç‰©
-- ==========================================
local npcFolder = Workspace:WaitForChild("NPCs")

for _, mob in pairs(npcFolder:GetChildren()) do
	if GameConfig.Mobs[mob.Name] then
		local root = mob:FindFirstChild("HumanoidRootPart") or mob:FindFirstChild("Torso")
		local originCF = root and root.CFrame or mob:GetPivot()

		if not MobRegistry[mob.Name] then
			local template = mob:Clone()
			for _, script in pairs(template:GetDescendants()) do
				if script:IsA("Script") then script:Destroy() end
			end
			template.Parent = mobTemplateFolder
			MobRegistry[mob.Name] = template
		end

		handleMobLifecycle(mob, originCF)
		MobHandler.setupMob(mob)
	end
end

return MobHandler