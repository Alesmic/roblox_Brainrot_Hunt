local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

local MobHandler = {}

-- ==========================================
-- é…ç½®åŒº
-- ==========================================
local RESPAWN_TIME = 300       -- å¤æ´»å†·å´: 5åˆ†é’Ÿ
local CORPSE_LIFETIME = 3      -- å°¸ä½“ä¿ç•™æ—¶é—´

-- å­˜å‚¨æ€ªç‰©æ¨¡æ¿
local MobRegistry = {} 
local mobTemplateFolder = ServerStorage:FindFirstChild("MobTemplates")
if not mobTemplateFolder then
	mobTemplateFolder = Instance.new("Folder")
	mobTemplateFolder.Name = "MobTemplates"
	mobTemplateFolder.Parent = ServerStorage
end

-- è®°å½•å¤æ´»æ—¶é—´
MobHandler.DeadBosses = {} 

function MobHandler.getRespawnTime(mobName)
	return MobHandler.DeadBosses[mobName]
end

-- ==========================================
-- è¾…åŠ©åŠŸèƒ½ï¼šç»™äºˆç‰©å“ (ä¿ç•™ä½ çš„æ‰è½é€»è¾‘)
-- ==========================================
local function giveItemToPlayer(player, itemName)
	local tool = ServerStorage:FindFirstChild("Tools") and ServerStorage.Tools:FindFirstChild(itemName)
	if not tool then
		tool = ServerStorage:FindFirstChild("Items") and ServerStorage.Items:FindFirstChild(itemName)
	end

	if tool then
		local clone = tool:Clone()
		clone.Parent = player.Backpack

		-- å†™å…¥åº“å­˜æ•°æ®
		local inventory = player:FindFirstChild("Inventory")
		if inventory then
			local itemVal = inventory:FindFirstChild(itemName)
			if not itemVal then
				itemVal = Instance.new("IntValue")
				itemVal.Name = itemName
				itemVal.Value = 0
				itemVal.Parent = inventory
			end
			itemVal.Value = itemVal.Value + 1
		end
		return true
	else
		warn("âŒ [MobHandler] æ‰è½ç‰© '"..itemName.."' åœ¨ ServerStorage ä¸­æ‰¾ä¸åˆ°ï¼")
		return false
	end
end

-- ==========================================
-- æ ¸å¿ƒé€»è¾‘ï¼šå¤„ç†æ€ªç‰©æ­»äº¡å‘¨æœŸ
-- ==========================================
local function handleMobLifecycle(mob, originCFrame)
	local humanoid = mob:WaitForChild("Humanoid", 10)
	if not humanoid then return end

	-- ç›‘å¬æ­»äº¡
	humanoid.Died:Connect(function()
		print("ğŸ’€ [MobHandler] " .. mob.Name .. " å·²æ­»äº¡")

		-- [æ–°å¢] 1. è®°å½•å¤æ´»æ—¶é—´ (é˜²æ­¢è¿˜æ²¡å¤æ´»å°±è¢«è¯†åˆ«ä¸ºå­˜åœ¨)
		MobHandler.DeadBosses[mob.Name] = os.time() + RESPAWN_TIME

		-- è·å–å‡»æ€è€…
		local creatorTag = humanoid:FindFirstChild("creator")
		local killerPlayer = creatorTag and creatorTag.Value

		if killerPlayer then
			print("    ğŸ—¡ï¸ å‡»æ€è€…: " .. killerPlayer.Name)
			local mobConfig = GameConfig.Mobs[mob.Name]

			if mobConfig then
				-- A. ç»™äºˆç»éªŒ
				local leaderstats = killerPlayer:FindFirstChild("leaderstats")
				if leaderstats and leaderstats:FindFirstChild("Experience") then
					leaderstats.Experience.Value = leaderstats.Experience.Value + mobConfig.Exp
				end

				-- B. ç»™äºˆé‡‘å¸ (å¦‚æœé…ç½®æœ‰)
				if leaderstats and leaderstats:FindFirstChild("Gold") and mobConfig.GoldReward then
					leaderstats.Gold.Value = leaderstats.Gold.Value + mobConfig.GoldReward
				end

				-- C. æ›´æ–°ä»»åŠ¡è¿›åº¦ (Quest)
				local hiddenStats = killerPlayer:FindFirstChild("HiddenStats")
				if hiddenStats and GameConfig.Quests then
					for questID, questData in pairs(GameConfig.Quests) do
						if questData.TargetMob == mob.Name then
							local questStat = hiddenStats:FindFirstChild("Quest_" .. questID)
							if questStat and questStat.Value < questData.TargetCount then
								questStat.Value = questStat.Value + 1
								-- ç®€å•çš„ä»»åŠ¡å®Œæˆå³æ—¶å¥–åŠ±
								if questStat.Value == questData.TargetCount and questData.GoldReward then
									if leaderstats and leaderstats.Gold then
										leaderstats.Gold.Value = leaderstats.Gold.Value + questData.GoldReward
									end
								end
							end
						end
					end
				end

				-- D. ç‰©å“æ‰è½ (Drops)
				if mobConfig.Drops then
					for _, dropData in pairs(mobConfig.Drops) do
						if math.random() <= dropData.Chance then
							local success = giveItemToPlayer(killerPlayer, dropData.ItemName)
							if success then
								print("    ğŸ æ‰è½ç‰©å“: " .. dropData.ItemName)
							end
						end
					end
				end
			end
		end

		-- [å…³é”®] 2. é€šçŸ¥ BossRoomManager (èƒœåˆ©ç»“ç®—)
		local notifyEvent = ServerStorage:FindFirstChild("BossDeathNotify")
		if notifyEvent then
			print("ğŸ“¡ [MobHandler] å‘é€ Boss æ­»äº¡é€šçŸ¥: " .. mob.Name)
			notifyEvent:Fire(mob.Name)
		else
			-- ä¸ºäº†é˜²æ­¢é¦–æ¬¡è¿è¡Œæ‰¾ä¸åˆ°äº‹ä»¶ï¼Œå°è¯•å» _G æ‰¾ (å¤‡ç”¨æ–¹æ¡ˆ)
			if _G.BossRoomManager then
				_G.BossRoomManager.onBossDeath(mob.Name)
			else
				warn("âš ï¸ [MobHandler] æ‰¾ä¸åˆ° BossDeathNotify äº‹ä»¶ï¼Œä¹Ÿæ‰¾ä¸åˆ° _G.BossRoomManagerï¼")
			end
		end

		-- 3. å°¸ä½“æ¸…ç†
		task.delay(CORPSE_LIFETIME, function()
			if mob and mob.Parent then mob:Destroy() end
		end)

		-- 4. å¤æ´»å€’è®¡æ—¶
		task.delay(RESPAWN_TIME, function()
			MobHandler.respawnMob(mob.Name, originCFrame)
		end)
	end)
end

-- ==========================================
-- å¤æ´»ä¸åˆå§‹åŒ–åŠŸèƒ½
-- ==========================================
function MobHandler.respawnMob(mobName, spawnCFrame)
	local template = MobRegistry[mobName]
	if template then
		MobHandler.DeadBosses[mobName] = nil -- æ¸…é™¤æ­»äº¡è®°å½•

		local newMob = template:Clone()
		newMob.Name = mobName
		local root = newMob:FindFirstChild("HumanoidRootPart") or newMob:FindFirstChild("Torso")
		if root then root.CFrame = spawnCFrame else newMob:PivotTo(spawnCFrame) end

		newMob.Parent = Workspace:WaitForChild("NPCs")

		-- é‡æ–°ç»‘å®šç”Ÿå‘½å‘¨æœŸ
		handleMobLifecycle(newMob, spawnCFrame)
		MobHandler.setupMob(newMob)

		print("âœ¨ " .. mobName .. " å·²å¤æ´»ï¼")
	end
end

function MobHandler.setupMob(mob)
	local config = GameConfig.Mobs[mob.Name]
	if not config then return end

	local humanoid = mob:WaitForChild("Humanoid", 10)
	if humanoid then
		humanoid.MaxHealth = config.MaxHealth
		humanoid.Health = config.MaxHealth
		humanoid.WalkSpeed = config.WalkSpeed or 12
	end
end

-- ==========================================
-- åˆå§‹åŒ–ï¼šæ‰«æç°æœ‰æ€ªç‰©å¹¶å»ºç«‹æ¨¡æ¿
-- ==========================================
local npcFolder = Workspace:WaitForChild("NPCs")

for _, mob in pairs(npcFolder:GetChildren()) do
	if GameConfig.Mobs[mob.Name] then
		local root = mob:FindFirstChild("HumanoidRootPart") or mob:FindFirstChild("Torso")
		local originCF = root and root.CFrame or mob:GetPivot()

		-- åˆ›å»ºå¤‡ä»½æ¨¡æ¿ (ç”¨äºå¤æ´»)
		if not MobRegistry[mob.Name] then
			local template = mob:Clone()
			for _, script in pairs(template:GetDescendants()) do
				if script:IsA("Script") then script:Destroy() end
			end
			template.Parent = mobTemplateFolder
			MobRegistry[mob.Name] = template
		end

		handleMobLifecycle(mob, originCF)
		MobHandler.setupMob(mob)
	end
end

return MobHandler