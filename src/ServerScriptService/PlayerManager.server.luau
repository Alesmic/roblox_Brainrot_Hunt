local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- å¼•å…¥é…ç½®
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- [âš ï¸IMPORTANT] ä¿®æ”¹ç‰ˆæœ¬å·ä»¥é‡ç½®æ•°æ® (æµ‹è¯•ç”¨)
local PlayerDataStore = DataStoreService:GetDataStore("RPG_Data_v6_FixReward")

local JAPANESE_HOUSE_SPAWN = Vector3.new(-783.183, 36.304, 220.17)

-- ==========================================
-- 1. è‡ªåŠ¨ç¡®ä¿ RemoteEvent å­˜åœ¨ (æ ¸å¿ƒä¿®å¤)
-- ==========================================
local function ensureFolder(name)
	local folder = ReplicatedStorage:FindFirstChild(name)
	if not folder then
		folder = Instance.new("Folder")
		folder.Name = name
		folder.Parent = ReplicatedStorage
	end
	return folder
end

local RemoteEventFolder = ensureFolder("RemoteEvent")

local function ensureEvent(name)
	local ev = RemoteEventFolder:FindFirstChild(name)
	if not ev then
		ev = Instance.new("RemoteEvent")
		ev.Name = name
		ev.Parent = RemoteEventFolder
		print("ğŸ”¨ [PlayerManager] è‡ªåŠ¨åˆ›å»º RemoteEvent: " .. name)
	end
	return ev
end

local startTutorialEvent = ensureEvent("StartTutorial")
local finishTalkEvent = ensureEvent("FinishTutorialTalk") -- ä¿®å¤ç‚¹ï¼šç¡®ä¿å®ƒå­˜åœ¨ï¼
local UpdatePvPUIEvent = ensureEvent("UpdatePvPUI")

-- ==========================================
-- 2. ç©å®¶åŠ å…¥é€»è¾‘
-- ==========================================
Players.PlayerAdded:Connect(function(player)
	print("[PlayerManager] Player joined: " .. player.Name)

	-- 1. åˆ›å»ºåŸºç¡€å±æ€§ (leaderstats)
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local level = Instance.new("IntValue")
	level.Name = "Level"
	level.Parent = leaderstats

	local gold = Instance.new("IntValue")
	gold.Name = "Gold"
	gold.Parent = leaderstats

	local experience = Instance.new("IntValue")
	experience.Name = "Experience"
	experience.Value = 0
	experience.Parent = leaderstats

	-- [è¾…åŠ©å‡½æ•°] æ›´æ–°è¡€é‡
	local function updateHealthBasedOnLevel(humanoid, currentLevel)
		if not humanoid then return end
		local rewards = GameConfig.Leveling.RewardsPerLevel
		local baseHealth = GameConfig.DefaultPlayer.MaxHealth
		local newMaxHealth = baseHealth + ((currentLevel - 1) * rewards.HealthBonus)

		humanoid.MaxHealth = newMaxHealth
		humanoid.Health = newMaxHealth
		print("ğŸ’ª [Stats] è¡€é‡å·²æ›´æ–°ä¸º " .. newMaxHealth .. " (Lv." .. currentLevel .. ")")
	end

	-- ç›‘å¬å‡çº§
	experience.Changed:Connect(function(newXp)
		local currentLevel = level.Value
		local xpRequired = GameConfig.Leveling.GetXpRequired(currentLevel)

		if newXp >= xpRequired then
			level.Value = currentLevel + 1
			experience.Value = newXp - xpRequired 
			print("ğŸ‰ [Server] " .. player.Name .. " å‡çº§åˆ°äº† Lv." .. level.Value .. "!")

			local char = player.Character
			if char then
				local hum = char:FindFirstChild("Humanoid")
				if hum then updateHealthBasedOnLevel(hum, level.Value) end
			end
		end
	end)

	local hiddenStats = Instance.new("Folder")
	hiddenStats.Name = "HiddenStats"
	hiddenStats.Parent = player

	-- æ•™ç¨‹å®ŒæˆçŠ¶æ€
	local tutorialCompleted = Instance.new("BoolValue")
	tutorialCompleted.Name = "TutorialCompleted"
	tutorialCompleted.Value = false 
	tutorialCompleted.Parent = hiddenStats

	local pvpMode = Instance.new("BoolValue") 
	pvpMode.Name = "PvPMode"
	pvpMode.Value = false
	pvpMode.Parent = hiddenStats 

	local cityPvPActive = Instance.new("BoolValue") 
	cityPvPActive.Name = "CityPvPActive"
	cityPvPActive.Value = false
	cityPvPActive.Parent = hiddenStats 

	-- Inventory æ–‡ä»¶å¤¹
	local inventory = Instance.new("Folder")
	inventory.Name = "Inventory"
	inventory.Parent = player

	-- æ¸…ç† StarterGear
	local function cleanStarterGear()
		local gear = player:WaitForChild("StarterGear", 10)
		if not gear then return end
		local seen = {}
		for _, child in pairs(gear:GetChildren()) do
			if child:IsA("Tool") then
				if seen[child.Name] then
					task.delay(0, function() child:Destroy() end)
				else
					seen[child.Name] = true
				end
			end
		end
	end
	cleanStarterGear()

	-- 3. è§’è‰²é‡ç”Ÿé€»è¾‘
	player.CharacterAdded:Connect(function(character)
		character:WaitForChild("HumanoidRootPart").CFrame = CFrame.new(JAPANESE_HOUSE_SPAWN)

		-- åº”ç”¨ç­‰çº§è¡€é‡
		local humanoid = character:WaitForChild("Humanoid")
		if level.Value > 1 then
			updateHealthBasedOnLevel(humanoid, level.Value)
		end

		-- æ¸…ç†èƒŒåŒ…é‡å¤é¡¹
		local backpack = player:WaitForChild("Backpack")
		local seenTools = {}
		for _, child in pairs(backpack:GetChildren()) do
			if child:IsA("Tool") then
				if seenTools[child.Name] then
					task.delay(0, function() child:Destroy() end)
				else
					seenTools[child.Name] = true
				end
			end
		end

		-- å…³é—­ PvP
		if pvpMode.Value == true then
			pvpMode.Value = false 
			cityPvPActive.Value = false 
			if UpdatePvPUIEvent then UpdatePvPUIEvent:FireClient(player, false) end
		end
	end)

	-- 4. åŠ è½½æ•°æ®
	local success, data = pcall(function()
		return PlayerDataStore:GetAsync(player.UserId)
	end)

	if success and data then
		level.Value = data.Level
		gold.Value = data.Gold
		experience.Value = data.Experience or 0

		if data.TutorialCompleted then
			tutorialCompleted.Value = true
			print("ğŸ“˜ [Data] ç©å®¶å·²å®Œæˆæ•™ç¨‹")
		end

		-- å†æ¬¡æ£€æŸ¥è¡€é‡ (é˜²æ­¢ç«æ€)
		local character = player.Character
		if character then
			local hum = character:FindFirstChild("Humanoid")
			if hum then updateHealthBasedOnLevel(hum, level.Value) end
		end

		-- åŠ è½½èƒŒåŒ…
		for itemName, qty in pairs(data.Inventory) do
			local itemConfig = GameConfig.Weapons[itemName] or GameConfig.Items[itemName] or GameConfig.Skin[itemName]
			local finalQty = qty
			if itemConfig and itemConfig.Category == "Weapons" then finalQty = 1 end

			local itemValue = Instance.new("IntValue")
			itemValue.Name = itemName
			itemValue.Value = finalQty
			itemValue.Parent = inventory

			-- å‘æ”¾ç‰©å“å®ä½“
			if itemConfig and (itemConfig.Category == "Weapons" or itemConfig.Category == "Tools") then
				local toolModel = ServerStorage:FindFirstChild("Tools") and ServerStorage.Tools:FindFirstChild(itemName)
				if toolModel then
					if not player.Backpack:FindFirstChild(itemName) then
						toolModel:Clone().Parent = player.Backpack
					end
					if not player.StarterGear:FindFirstChild(itemName) then
						toolModel:Clone().Parent = player.StarterGear
					end
				end
			end
		end
	else
		-- æ–°ç©å®¶é»˜è®¤å€¼
		level.Value = GameConfig.DefaultPlayer.Level
		gold.Value = GameConfig.DefaultPlayer.Gold
	end
end)

-- ç©å®¶é€€å‡ºä¿å­˜
Players.PlayerRemoving:Connect(function(player)
	local leaderstats = player:FindFirstChild("leaderstats")
	local inventory = player:FindFirstChild("Inventory")
	local hiddenStats = player:FindFirstChild("HiddenStats") 

	if leaderstats and inventory then
		local dataToSave = {
			Level = leaderstats.Level.Value,
			Gold = leaderstats.Gold.Value,
			Experience = leaderstats.Experience.Value,
			Inventory = {},
			TutorialCompleted = false
		}

		if hiddenStats and hiddenStats:FindFirstChild("TutorialCompleted") then
			dataToSave.TutorialCompleted = hiddenStats.TutorialCompleted.Value
		end

		for _, itemValue in pairs(inventory:GetChildren()) do
			if itemValue:IsA("IntValue") then
				dataToSave.Inventory[itemValue.Name] = itemValue.Value
			end
		end

		pcall(function() PlayerDataStore:SetAsync(player.UserId, dataToSave) end)
		print("ğŸ’¾ æ•°æ®å·²ä¿å­˜: " .. player.Name)
	end
end)

-- ==========================================
-- 5. å¤„ç†æ–°æ‰‹ä»»åŠ¡å®Œæˆ (æ ¸å¿ƒä¿®å¤)
-- ==========================================
finishTalkEvent.OnServerEvent:Connect(function(player)
	print("ğŸ [Server] æ”¶åˆ°æ–°æ‰‹å®Œæˆè¯·æ±‚: " .. player.Name)

	-- 1. å‘æ”¾æ­¦å™¨ (Bat)
	local weaponName = "Bat"
	local toolsFolder = ServerStorage:FindFirstChild("Tools")

	if toolsFolder then
		local weapon = toolsFolder:FindFirstChild(weaponName)
		if weapon then
			-- æ£€æŸ¥æ˜¯å¦å·²æœ‰
			local hasWeapon = player.Backpack:FindFirstChild(weaponName) or player.StarterGear:FindFirstChild(weaponName)

			if not hasWeapon then
				-- ç»™èƒŒåŒ…
				local w1 = weapon:Clone()
				w1.Parent = player.Backpack

				-- ç»™å­˜æ¡£ (StarterGear)
				local w2 = weapon:Clone()
				w2.Parent = player.StarterGear

				print("    âš”ï¸ æ­¦å™¨ [Bat] å·²å‘æ”¾ç»™ " .. player.Name)

				-- æ›´æ–° Inventory æ•°æ® (å¦åˆ™ä¸‹çº¿å°±æ²¡äº†)
				local inventory = player:FindFirstChild("Inventory")
				if inventory then
					local itemVal = inventory:FindFirstChild(weaponName)
					if not itemVal then
						itemVal = Instance.new("IntValue")
						itemVal.Name = weaponName
						itemVal.Value = 1
						itemVal.Parent = inventory
					end
				end
			else
				warn("    âš ï¸ ç©å®¶å·²æœ‰æ­¦å™¨ï¼Œè·³è¿‡å‘æ”¾")
			end
		else
			warn("    âŒ ä¸¥é‡é”™è¯¯: åœ¨ ServerStorage/Tools é‡Œæ‰¾ä¸åˆ° " .. weaponName)
		end
	else
		warn("    âŒ ä¸¥é‡é”™è¯¯: ServerStorage ä¸‹æ²¡æœ‰ Tools æ–‡ä»¶å¤¹!")
	end

	-- 2. å‘æ”¾ä»»åŠ¡ & æ ‡è®°å®Œæˆ
	local hiddenStats = player:FindFirstChild("HiddenStats")
	if hiddenStats then
		-- æ ‡è®°æ•™ç¨‹å·²å®Œæˆ
		if hiddenStats:FindFirstChild("TutorialCompleted") then
			hiddenStats.TutorialCompleted.Value = true
			print("    âœ… æ•™ç¨‹çŠ¶æ€æ ‡è®°ä¸º: å®Œæˆ")
		end

		-- å‘æ”¾æ€æ€ªä»»åŠ¡
		local questName = "Quest_SamuraiSlayer"
		if not hiddenStats:FindFirstChild(questName) then
			local qVal = Instance.new("IntValue")
			qVal.Name = questName
			qVal.Value = 0
			qVal.Parent = hiddenStats
			print("    ğŸ“œ ä»»åŠ¡å·²æ¥å–: " .. questName)
		end
	end
end)