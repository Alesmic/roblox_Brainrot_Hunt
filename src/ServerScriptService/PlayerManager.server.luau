local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- å¼•å…¥é…ç½®
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- [âš ï¸IMPORTANT] ä¿®æ”¹ç‰ˆæœ¬å·ä»¥é‡ç½®æ•°æ® (æµ‹è¯•ç”¨)
-- æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ–°çš„ Key æ¥ç¡®ä¿æ•°æ®ç»“æ„å¹²å‡€ï¼Œé¿å…æ—§æ•°æ®å¹²æ‰°
local PlayerDataStore = DataStoreService:GetDataStore("RPG_Data_Final_Fix_v1")

local JAPANESE_HOUSE_SPAWN = Vector3.new(-783.183, 36.304, 220.17)

-- ==========================================
-- 1. è‡ªåŠ¨ç¡®ä¿ RemoteEvent å­˜åœ¨
-- ==========================================
local function ensureFolder(name)
	local folder = ReplicatedStorage:FindFirstChild(name)
	if not folder then
		folder = Instance.new("Folder")
		folder.Name = name
		folder.Parent = ReplicatedStorage
	end
	return folder
end

local RemoteEventFolder = ensureFolder("RemoteEvent")

local function ensureEvent(name)
	local ev = RemoteEventFolder:FindFirstChild(name)
	if not ev then
		ev = Instance.new("RemoteEvent")
		ev.Name = name
		ev.Parent = RemoteEventFolder
		print("ğŸ”¨ [PlayerManager] è‡ªåŠ¨åˆ›å»º RemoteEvent: " .. name)
	end
	return ev
end

local startTutorialEvent = ensureEvent("StartTutorial")
local finishTalkEvent = ensureEvent("FinishTutorialTalk")
local UpdatePvPUIEvent = ensureEvent("UpdatePvPUI")

-- ==========================================
-- 2. ç©å®¶åŠ å…¥é€»è¾‘
-- ==========================================
Players.PlayerAdded:Connect(function(player)
	print("[PlayerManager] Player joined: " .. player.Name)

	-- 1. åˆ›å»ºåŸºç¡€å±æ€§ (leaderstats)
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local level = Instance.new("IntValue")
	level.Name = "Level"
	level.Parent = leaderstats

	local gold = Instance.new("IntValue")
	gold.Name = "Gold"
	gold.Parent = leaderstats

	local experience = Instance.new("IntValue")
	experience.Name = "Experience"
	experience.Value = 0
	experience.Parent = leaderstats

	-- [è¾…åŠ©å‡½æ•°] æ›´æ–°è¡€é‡
	local function updateHealthBasedOnLevel(humanoid, currentLevel)
		if not humanoid then return end
		local rewards = GameConfig.Leveling.RewardsPerLevel
		local baseHealth = GameConfig.DefaultPlayer.MaxHealth
		local newMaxHealth = baseHealth + ((currentLevel - 1) * rewards.HealthBonus)

		humanoid.MaxHealth = newMaxHealth
		humanoid.Health = newMaxHealth
		print("ğŸ’ª [Stats] è¡€é‡å·²æ›´æ–°ä¸º " .. newMaxHealth .. " (Lv." .. currentLevel .. ")")
	end

	-- ç›‘å¬å‡çº§
	experience.Changed:Connect(function(newXp)
		local currentLevel = level.Value
		local xpRequired = GameConfig.Leveling.GetXpRequired(currentLevel)

		if newXp >= xpRequired then
			level.Value = currentLevel + 1
			experience.Value = newXp - xpRequired 
			print("ğŸ‰ [Server] " .. player.Name .. " å‡çº§åˆ°äº† Lv." .. level.Value .. "!")

			local char = player.Character
			if char then
				local hum = char:FindFirstChild("Humanoid")
				if hum then updateHealthBasedOnLevel(hum, level.Value) end
			end
		end
	end)

	local hiddenStats = Instance.new("Folder")
	hiddenStats.Name = "HiddenStats"
	hiddenStats.Parent = player

	-- æ•™ç¨‹å®ŒæˆçŠ¶æ€
	local tutorialCompleted = Instance.new("BoolValue")
	tutorialCompleted.Name = "TutorialCompleted"
	tutorialCompleted.Value = false 
	tutorialCompleted.Parent = hiddenStats

	local pvpMode = Instance.new("BoolValue") 
	pvpMode.Name = "PvPMode"
	pvpMode.Value = false
	pvpMode.Parent = hiddenStats 

	local cityPvPActive = Instance.new("BoolValue") 
	cityPvPActive.Name = "CityPvPActive"
	cityPvPActive.Value = false
	cityPvPActive.Parent = hiddenStats 

	-- Inventory æ–‡ä»¶å¤¹
	local inventory = Instance.new("Folder")
	inventory.Name = "Inventory"
	inventory.Parent = player

	-- æ¸…ç† StarterGear
	local function cleanStarterGear()
		local gear = player:WaitForChild("StarterGear", 10)
		if not gear then return end
		local seen = {}
		for _, child in pairs(gear:GetChildren()) do
			if child:IsA("Tool") then
				if seen[child.Name] then
					task.delay(0, function() child:Destroy() end)
				else
					seen[child.Name] = true
				end
			end
		end
	end
	cleanStarterGear()

	-- 3. è§’è‰²é‡ç”Ÿé€»è¾‘
	player.CharacterAdded:Connect(function(character)
		character:WaitForChild("HumanoidRootPart").CFrame = CFrame.new(JAPANESE_HOUSE_SPAWN)

		-- åº”ç”¨ç­‰çº§è¡€é‡
		local humanoid = character:WaitForChild("Humanoid")
		if level.Value > 1 then
			updateHealthBasedOnLevel(humanoid, level.Value)
		end

		-- æ¸…ç†èƒŒåŒ…é‡å¤é¡¹
		local backpack = player:WaitForChild("Backpack")
		local seenTools = {}
		for _, child in pairs(backpack:GetChildren()) do
			if child:IsA("Tool") then
				if seenTools[child.Name] then
					task.delay(0, function() child:Destroy() end)
				else
					seenTools[child.Name] = true
				end
			end
		end

		-- å…³é—­ PvP
		if pvpMode.Value == true then
			pvpMode.Value = false 
			cityPvPActive.Value = false 
			if UpdatePvPUIEvent then UpdatePvPUIEvent:FireClient(player, false) end
		end
	end)

	-- 4. åŠ è½½æ•°æ®
	local success, data = pcall(function()
		return PlayerDataStore:GetAsync(player.UserId)
	end)

	if success and data then
		level.Value = data.Level or 1
		gold.Value = data.Gold or 0
		experience.Value = data.Experience or 0

		if data.TutorialCompleted then
			tutorialCompleted.Value = true
			print("ğŸ“˜ [Data] ç©å®¶å·²å®Œæˆæ•™ç¨‹")
		end

		-- [æ–°å¢] æ¢å¤ä»»åŠ¡è¿›åº¦
		if data.Quests then
			for questName, val in pairs(data.Quests) do
				local qVal = Instance.new("IntValue")
				qVal.Name = questName
				qVal.Value = val
				qVal.Parent = hiddenStats
				print("    ğŸ“œ æ¢å¤ä»»åŠ¡: " .. questName .. " = " .. val)
			end
		end

		-- å†æ¬¡æ£€æŸ¥è¡€é‡
		local character = player.Character
		if character then
			local hum = character:FindFirstChild("Humanoid")
			if hum then updateHealthBasedOnLevel(hum, level.Value) end
		end

		-- åŠ è½½èƒŒåŒ…
		if data.Inventory then
			for itemName, qty in pairs(data.Inventory) do
				local itemConfig = GameConfig.Weapons[itemName] or GameConfig.Items[itemName] or GameConfig.Skin[itemName]
				local finalQty = qty
				if itemConfig and itemConfig.Category == "Weapons" then finalQty = 1 end

				local itemValue = Instance.new("IntValue")
				itemValue.Name = itemName
				itemValue.Value = finalQty
				itemValue.Parent = inventory

				-- å‘æ”¾ç‰©å“å®ä½“
				if itemConfig and (itemConfig.Category == "Weapons" or itemConfig.Category == "Tools") then
					local toolModel = ServerStorage:FindFirstChild("Tools") and ServerStorage.Tools:FindFirstChild(itemName)
					if toolModel then
						if not player.Backpack:FindFirstChild(itemName) then
							toolModel:Clone().Parent = player.Backpack
						end
						if not player.StarterGear:FindFirstChild(itemName) then
							toolModel:Clone().Parent = player.StarterGear
						end
					end
				end
			end
		end
	else
		-- æ–°ç©å®¶é»˜è®¤å€¼
		level.Value = GameConfig.DefaultPlayer.Level
		gold.Value = GameConfig.DefaultPlayer.Gold

		-- [ä¿é™©æªæ–½] å¦‚æœæ˜¯æ–°ç©å®¶ï¼Œä¸”æ²¡æœ‰ä»»åŠ¡ï¼Œé»˜è®¤ç»™ä¸€ä¸ª0è¿›åº¦çš„æ–°æ‰‹ä»»åŠ¡(å¯é€‰)
		-- ä½†ç”±äºæœ‰æ•™ç¨‹ç³»ç»Ÿï¼Œè¿™é‡Œå¯ä»¥ä¸ç»™ï¼Œç­‰æ•™ç¨‹è§¦å‘
	end
end)

-- ç©å®¶é€€å‡ºä¿å­˜
Players.PlayerRemoving:Connect(function(player)
	local leaderstats = player:FindFirstChild("leaderstats")
	local inventory = player:FindFirstChild("Inventory")
	local hiddenStats = player:FindFirstChild("HiddenStats") 

	if leaderstats and inventory then
		local dataToSave = {
			Level = leaderstats.Level.Value,
			Gold = leaderstats.Gold.Value,
			Experience = leaderstats.Experience.Value,
			Inventory = {},
			TutorialCompleted = false,
			Quests = {} -- [æ–°å¢] ä»»åŠ¡è¡¨
		}

		if hiddenStats then
			if hiddenStats:FindFirstChild("TutorialCompleted") then
				dataToSave.TutorialCompleted = hiddenStats.TutorialCompleted.Value
			end

			-- [æ–°å¢] ä¿å­˜æ‰€æœ‰ Quest_ å¼€å¤´çš„ä»»åŠ¡
			for _, child in pairs(hiddenStats:GetChildren()) do
				if string.sub(child.Name, 1, 6) == "Quest_" then
					dataToSave.Quests[child.Name] = child.Value
				end
			end
		end

		for _, itemValue in pairs(inventory:GetChildren()) do
			if itemValue:IsA("IntValue") then
				dataToSave.Inventory[itemValue.Name] = itemValue.Value
			end
		end

		pcall(function() PlayerDataStore:SetAsync(player.UserId, dataToSave) end)
		print("ğŸ’¾ æ•°æ®å·²ä¿å­˜: " .. player.Name)
	end
end)

-- ==========================================
-- 5. å¤„ç†æ–°æ‰‹ä»»åŠ¡å®Œæˆ
-- ==========================================
finishTalkEvent.OnServerEvent:Connect(function(player)
	print("ğŸ [Server] æ”¶åˆ°æ–°æ‰‹å®Œæˆè¯·æ±‚: " .. player.Name)

	-- 1. å‘æ”¾æ­¦å™¨ (Bat)
	local weaponName = "Bat"
	local toolsFolder = ServerStorage:FindFirstChild("Tools")

	if toolsFolder then
		local weapon = toolsFolder:FindFirstChild(weaponName)
		if weapon then
			local hasWeapon = player.Backpack:FindFirstChild(weaponName) or player.StarterGear:FindFirstChild(weaponName)

			if not hasWeapon then
				weapon:Clone().Parent = player.Backpack
				weapon:Clone().Parent = player.StarterGear

				print("    âš”ï¸ æ­¦å™¨ [Bat] å·²å‘æ”¾ç»™ " .. player.Name)

				local inventory = player:FindFirstChild("Inventory")
				if inventory then
					local itemVal = inventory:FindFirstChild(weaponName)
					if not itemVal then
						itemVal = Instance.new("IntValue")
						itemVal.Name = weaponName
						itemVal.Value = 1
						itemVal.Parent = inventory
					end
				end
			end
		end
	end

	-- 2. å‘æ”¾ä»»åŠ¡ & æ ‡è®°å®Œæˆ
	local hiddenStats = player:FindFirstChild("HiddenStats")
	if hiddenStats then
		if hiddenStats:FindFirstChild("TutorialCompleted") then
			hiddenStats.TutorialCompleted.Value = true
			print("    âœ… æ•™ç¨‹çŠ¶æ€æ ‡è®°ä¸º: å®Œæˆ")
		end

		local questName = "Quest_SamuraiSlayer"
		if not hiddenStats:FindFirstChild(questName) then
			local qVal = Instance.new("IntValue")
			qVal.Name = questName
			qVal.Value = 0
			qVal.Parent = hiddenStats
			print("    ğŸ“œ ä»»åŠ¡å·²æ¥å–: " .. questName)
		end
	end
end)