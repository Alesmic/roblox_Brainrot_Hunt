local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

-- ==========================================
-- 0. è‡ªåŠ¨è¡¥å…¨å¿…è¦çš„äº‹ä»¶
-- ==========================================
local RemoteEventFolder = ReplicatedStorage:FindFirstChild("RemoteEvent") or Instance.new("Folder", ReplicatedStorage)
RemoteEventFolder.Name = "RemoteEvent"

local BossEvent = RemoteEventFolder:FindFirstChild("BossEvent") or Instance.new("RemoteEvent", RemoteEventFolder)
BossEvent.Name = "BossEvent"

local BossDeathNotify = ServerStorage:FindFirstChild("BossDeathNotify") or Instance.new("BindableEvent", ServerStorage)
BossDeathNotify.Name = "BossDeathNotify"

-- ==========================================
-- é…ç½®åŒº (ä¸å†å†™æ­»å•ä¸€ Boss)
-- ==========================================
-- çŠ¶æ€è®°å½•: { [UserId] = {BossName = "xxx", RoomFolder = Folder} }
local playersInBossFight = {}

-- è¾…åŠ©å‡½æ•°ï¼šæ ¹æ® Boss åå­—æ‰¾åˆ°å¯¹åº”çš„æˆ¿é—´é…ç½®
-- å‡è®¾ä½ çš„åœ°å›¾ç»“æ„æ˜¯: Workspace -> Boss Area (Saharan Master) -> BossArenaSpawn
--                     Workspace -> Boss Area (New Boss) -> BossArenaSpawn
-- å»ºè®®ç»™æ¯ä¸ª Boss æˆ¿é—´çš„æ–‡ä»¶å¤¹èµ·ä¸ªç‹¬ç‰¹çš„åå­—ï¼Œæˆ–è€…åœ¨è¿™é‡Œåšä¸ªæ˜ å°„è¡¨
local BOSS_LOCATIONS = {
	["Saharan Master"] = "Boss Area", -- å¯¹åº” Workspace["Boss Area"]
	["Forest King"] = "Forest Boss Area", -- <--- [æ–°å¢] ä½ çš„æ–° Boss æˆ¿é—´æ–‡ä»¶å¤¹åå­—
	-- åœ¨è¿™é‡Œæ·»åŠ æ›´å¤š Boss...
}

local function getLocations(bossName)
	local areaName = BOSS_LOCATIONS[bossName] or "Boss Area" -- é»˜è®¤å€¼
	local area = Workspace:FindFirstChild(areaName)

	if not area then 
		-- å°è¯•ç›´æ¥åœ¨ Workspace æ‰¾ä»¥ Boss åå­—å‘½åçš„æ–‡ä»¶å¤¹
		area = Workspace:FindFirstChild(bossName .. " Room") 
	end

	if not area then return nil, nil end
	return area:FindFirstChild("BossArenaSpawn"), area:FindFirstChild("BossRoomExitPoint")
end

-- ==========================================
-- 1. ç©å®¶è¿›å…¥é€»è¾‘
-- ==========================================
BossEvent.OnServerEvent:Connect(function(player, action, arg1)
	if action == "EnterBossRoom" then
		-- å®¢æˆ·ç«¯ç°åœ¨åº”è¯¥å‘é€ Boss åå­—: BossEvent:FireServer("EnterBossRoom", "Saharan Master")
		local bossName = arg1 or "Saharan Master" -- å…¼å®¹æ—§ä»£ç ï¼Œé»˜è®¤ä¸º Saharan Master

		print("ğŸ‘‰ [BossRoom] ç©å®¶ " .. player.Name .. " è¯·æ±‚æŒ‘æˆ˜: " .. bossName)

		local spawnPoint, exitPoint = getLocations(bossName)
		if not spawnPoint then 
			warn("âŒ [BossRoom] æ‰¾ä¸åˆ°ä¼ é€ç‚¹ï¼Œè¯·æ£€æŸ¥ BOSS_LOCATIONS é…ç½®")
			return 
		end

		-- æ£€æŸ¥ Boss æ˜¯å¦å­˜åœ¨ (é˜²ä½œå¼Š)
		local boss = Workspace:WaitForChild("NPCs"):FindFirstChild(bossName)
		if not boss then
			BossEvent:FireClient(player, "Error", "Boss is respawning (Cooldown 5min)")
			return
		end

		-- ä¼ é€
		local char = player.Character
		if char and char:FindFirstChild("HumanoidRootPart") then
			char.HumanoidRootPart.CFrame = spawnPoint.CFrame + Vector3.new(0, 3, 0)

			-- è®°å½•ç©å®¶æ­£åœ¨æ‰“å“ªä¸ª Boss
			playersInBossFight[player.UserId] = {
				Name = bossName,
				ExitPoint = exitPoint
			}

			-- ç›‘å¬æ­»äº¡ (å¤±è´¥åˆ¤å®š)
			local humanoid = char:FindFirstChild("Humanoid")
			if humanoid then
				humanoid.Died:Connect(function()
					local fightInfo = playersInBossFight[player.UserId]
					if fightInfo then
						print("ğŸ’€ [BossRoom] ç©å®¶å¤±è´¥: " .. player.Name)
						playersInBossFight[player.UserId] = nil 

						BossEvent:FireClient(player, "ShowResult", "Defeat")
						player:SetAttribute("RespawnAtBossExit", true)
						-- ä¸´æ—¶å­˜ä¸€ä¸‹å‡ºå£ä½ç½®åï¼Œä»¥ä¾¿å¤æ´»è„šæœ¬æ‰¾åˆ°
						player:SetAttribute("ExitTargetName", fightInfo.Name) 
					end
				end)
			end
		end
	end
end)

-- ==========================================
-- 2. ç©å®¶å¤æ´»å¤„ç†
-- ==========================================
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(char)
		if player:GetAttribute("RespawnAtBossExit") then
			player:SetAttribute("RespawnAtBossExit", nil) 
			local bossName = player:GetAttribute("ExitTargetName") or "Saharan Master"

			local _, exitPoint = getLocations(bossName)
			if exitPoint then
				task.wait(0.5) 
				local root = char:WaitForChild("HumanoidRootPart")
				if root then
					root.CFrame = exitPoint.CFrame + Vector3.new(0, 3, 0)
				end
			end
		end
	end)
end)

-- ==========================================
-- 3. Boss æ­»äº¡é€»è¾‘ (èƒœåˆ©å¤„ç†)
-- ==========================================
BossDeathNotify.Event:Connect(function(deadBossName)
	print("âš”ï¸ [BossRoom] æ”¶åˆ°æ­»äº¡é€šçŸ¥: " .. tostring(deadBossName))

	for userId, fightInfo in pairs(playersInBossFight) do
		-- åªæœ‰æ­£åœ¨æ‰“è¿™ä¸ª Boss çš„ç©å®¶æ‰ç®—èµ¢
		if fightInfo.Name == deadBossName then
			local player = Players:GetPlayerByUserId(userId)
			if player then
				print("ğŸ† [BossRoom] èƒœåˆ©: " .. player.Name)
				BossEvent:FireClient(player, "ShowResult", "Victory")

				-- 3ç§’åè¸¢å‡º
				task.delay(3, function()
					local char = player.Character
					if char and char:FindFirstChild("HumanoidRootPart") and fightInfo.ExitPoint then
						char.HumanoidRootPart.CFrame = fightInfo.ExitPoint.CFrame + Vector3.new(0, 3, 0)
					end
				end)
			end
			-- æ¸…é™¤çŠ¶æ€
			playersInBossFight[userId] = nil
		end
	end
end)