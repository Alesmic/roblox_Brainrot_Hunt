local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerStorage = game:GetService("ServerStorage")

-- å¼•å…¥é…ç½®æ–‡ä»¶
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- ==========================================
-- 1. è¿œç¨‹æ¥å£è‡ªåŠ¨åˆå§‹åŒ–
-- ==========================================
local function ensureFolder(name, parent)
	local folder = parent:FindFirstChild(name)
	if not folder then
		folder = Instance.new("Folder"); folder.Name = name; folder.Parent = parent
	end
	return folder
end

local RemoteFunctionFolder = ensureFolder("RemoteFunction", ReplicatedStorage)
local RemoteEventFolder = ensureFolder("RemoteEvent", ReplicatedStorage)

local function ensureRemoteFunc(name)
	local rf = RemoteFunctionFolder:FindFirstChild(name)
	if not rf then rf = Instance.new("RemoteFunction"); rf.Name = name; rf.Parent = RemoteFunctionFolder end
	return rf
end

local function ensureRemoteEvent(name)
	local re = RemoteEventFolder:FindFirstChild(name)
	if not re then re = Instance.new("RemoteEvent"); re.Name = name; re.Parent = RemoteEventFolder end
	return re
end

-- åˆå§‹åŒ–æ¥å£
local buyItemFunc = ensureRemoteFunc("BuyItem")
local getInvFunc = ensureRemoteFunc("GetInventoryData")
local sellEvent = ensureRemoteEvent("SellItem")

ensureRemoteEvent("StartTradeUI")
ensureRemoteEvent("QuestCompleted") -- [æ–°å¢] ç”¨äºé€šçŸ¥å®¢æˆ·ç«¯æ˜¾ç¤ºå¥–åŠ±å¼¹çª—
ensureRemoteEvent("HandleTradeAction")
ensureRemoteEvent("UpdateTradeUI")
ensureRemoteEvent("BossBattleEvent")
ensureRemoteEvent("OpenShopUI") 
ensureRemoteEvent("OpenDoctorUI")

print("âœ… [InventorySystem] è¿œç¨‹æ¥å£åŠ è½½å®Œæ¯•")

-- ==========================================
-- 2. å®ä½“é“å…·åŒæ­¥å™¨ (æ ¸å¿ƒä¿®å¤ï¼šå« StarterGear)
-- ==========================================
local function syncPhysicalTool(player, itemName, dataQty)
	-- å°è¯•ä» ServerStorage è·å–é“å…·æ¨¡å‹
	local toolModel = nil
	if ServerStorage:FindFirstChild("Tools") then
		toolModel = ServerStorage.Tools:FindFirstChild(itemName)
	end
	-- å…¼å®¹æ—§ç»“æ„
	if not toolModel and ServerStorage:FindFirstChild("Items") then
		toolModel = ServerStorage.Items:FindFirstChild(itemName)
	end

	-- å¦‚æœæœåŠ¡å™¨æ²¡æœ‰è¿™ä¸ªé“å…·æ¨¡å‹ï¼Œå°±åªç®¡æ•°æ®ï¼Œä¸ç®¡å®ä½“
	if not toolModel then return end

	local backpack = player:WaitForChild("Backpack")
	local starterGear = player:WaitForChild("StarterGear") -- [æ–°å¢] è·å– StarterGear
	local character = player.Character

	-- A. ç»Ÿè®¡å½“å‰æŒæœ‰çš„å®ä½“æ•°é‡
	local currentPhysicalCount = 0
	local toolsToRemove = {}

	-- æ£€æŸ¥èƒŒåŒ…
	for _, t in pairs(backpack:GetChildren()) do
		if t.Name == itemName then
			currentPhysicalCount += 1
			table.insert(toolsToRemove, t)
		end
	end
	-- æ£€æŸ¥æ‰‹ä¸Š (Character)
	if character then
		local handTool = character:FindFirstChild(itemName)
		if handTool then
			currentPhysicalCount += 1
			table.insert(toolsToRemove, handTool)
		end
	end

	-- B. åŒæ­¥é€»è¾‘
	if dataQty > 0 then
		-- [è·å¾—ç‰©å“]

		-- 1. ç¡®ä¿èƒŒåŒ…é‡Œæœ‰ (å¦‚æœæ˜¯æ­¦å™¨ä¸”åªèƒ½æŒæœ‰ä¸€æŠŠï¼Œç¡®ä¿ä¸é‡å¤)
		local conf = GameConfig.Weapons[itemName]
		if conf and currentPhysicalCount >= 1 then 
			-- æ­¦å™¨å·²æœ‰ï¼Œä¸å†å‘æ”¾
		else
			-- éœ€è¦å‘æ”¾ (æ¯”å¦‚æ¶ˆè€—å“å †å ï¼Œæˆ–è€…è¿˜æ²¡æ­¦å™¨)
			if currentPhysicalCount < dataQty then
				local need = dataQty - currentPhysicalCount
				for i = 1, need do
					toolModel:Clone().Parent = backpack
				end
			end
		end

		-- 2. [å…³é”®] åŒæ­¥åˆ° StarterGear (ç¡®ä¿é‡ç”Ÿåè¿˜æœ‰)
		if not starterGear:FindFirstChild(itemName) then
			toolModel:Clone().Parent = starterGear
		end

	else
		-- [å¤±å»/å‡ºå”®ç‰©å“] -> dataQty <= 0

		-- 1. åˆ é™¤èƒŒåŒ…å’Œæ‰‹ä¸Šçš„
		for _, t in pairs(toolsToRemove) do
			t:Destroy()
		end

		-- 2. [æ ¸å¿ƒä¿®å¤] åˆ é™¤ StarterGear é‡Œçš„å¤‡ä»½ (é˜²æ­¢æ— æ³•å†æ¬¡è´­ä¹°)
		local sgTool = starterGear:FindFirstChild(itemName)
		if sgTool then
			sgTool:Destroy()
			print("â™»ï¸ [InventorySystem] å·²æ¸…é™¤ StarterGear ä¸­çš„: " .. itemName)
		end
	end
end

local function bindInventorySync(player)
	local inv = player:WaitForChild("Inventory", 10)
	if not inv then return end

	-- åˆå§‹åŒæ­¥
	for _, item in pairs(inv:GetChildren()) do
		syncPhysicalTool(player, item.Name, item.Value)
		item.Changed:Connect(function(newVal)
			syncPhysicalTool(player, item.Name, newVal)
		end)
	end

	-- ç›‘å¬æ–°ç‰©å“
	inv.ChildAdded:Connect(function(child)
		if child:IsA("IntValue") then
			syncPhysicalTool(player, child.Name, child.Value)
			child.Changed:Connect(function(newVal)
				syncPhysicalTool(player, child.Name, newVal)
			end)
		end
	end)
end

-- ==========================================
-- 3. è§„åˆ™æ ¡éªŒä¸è´­ä¹°é€»è¾‘
-- ==========================================
local function canPlayerReceiveItem(player, itemName, addQty)
	local inv = player:FindFirstChild("Inventory")
	if not inv then return false, "Inventory Error" end

	local conf = GameConfig.Weapons[itemName] or GameConfig.Items[itemName] or GameConfig.Skin[itemName]
	if not conf then return false, "Invalid Item" end

	if conf.Category == "Weapons" then
		-- æ­¦å™¨å”¯ä¸€æ€§æ£€æŸ¥
		if inv:FindFirstChild(itemName) then
			return false, "Item Limit: Weapon Unique"
		end
	end

	if itemName == "Medpack" then
		local currentQty = inv:FindFirstChild(itemName) and inv:FindFirstChild(itemName).Value or 0
		if currentQty + addQty > 3 then
			return false, "Item Limit: Max 3 Medpacks"
		end
	end

	return true, ""
end
_G.CanReceiveItem = canPlayerReceiveItem

-- è´­ä¹°å¤„ç† (InventorySystem ç‰ˆ)
buyItemFunc.OnServerInvoke = function(player, itemName)
	local conf = GameConfig.Weapons[itemName] or GameConfig.Items[itemName] or GameConfig.Skin[itemName]
	if not conf then return false, "No Config" end

	local can, reason = canPlayerReceiveItem(player, itemName, 1)
	if not can then return false, reason end

	local gold = player.leaderstats.Gold
	if gold.Value < (conf.Price or 0) then return false, "No Gold" end

	gold.Value = gold.Value - (conf.Price or 0)

	local inv = player:FindFirstChild("Inventory")
	local itemVal = inv:FindFirstChild(itemName)
	if itemVal then
		itemVal.Value = itemVal.Value + 1
	else
		local newVal = Instance.new("IntValue")
		newVal.Name = itemName
		newVal.Value = 1
		newVal.Parent = inv
	end

	return true, "Success"
end

-- [å‡ºå”®å¤„ç†] æ ¸å¿ƒé€»è¾‘
sellEvent.OnServerEvent:Connect(function(player, itemName, _, qty)
	local inv = player:FindFirstChild("Inventory")
	local itemVal = inv and inv:FindFirstChild(itemName)
	local conf = GameConfig.Weapons[itemName] or GameConfig.Items[itemName] or GameConfig.Skin[itemName]

	if itemVal and itemVal.Value >= qty then
		-- 1. æ‰£é™¤æ•°é‡
		itemVal.Value = itemVal.Value - qty

		-- 2. åŠ é’±
		local gain = math.floor((conf.Price or 0) * 0.5) * qty
		-- ç‰¹æ®Šä¿åº•é€»è¾‘ (é˜²æ­¢0å…ƒç‰©å“å–å‡º0å…ƒ)
		if gain <= 0 and conf.CanSell then
			if conf.Rarity == "Legendary" then gain = 200
			elseif conf.Rarity == "Rare" then gain = 50
			else gain = 10 end
		end
		player.leaderstats.Gold.Value = player.leaderstats.Gold.Value + gain

		-- 3. å¦‚æœæ•°é‡å½’é›¶ï¼Œé”€æ¯æ•°æ®
		-- è¿™ä¼šè§¦å‘ itemVal.Changed æˆ– ChildRemovedï¼Œè¿›è€Œè§¦å‘ syncPhysicalTool(..., 0)
		-- ä»è€Œæ¸…ç† Backpack å’Œ StarterGear
		if itemVal.Value <= 0 then
			-- æ˜¾å¼è°ƒç”¨ä¸€æ¬¡æ¸…ç†ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
			syncPhysicalTool(player, itemName, 0)
			itemVal:Destroy()
		end

		print("ğŸ’° [Server] ç©å®¶å‡ºå”®äº† " .. itemName .. " è·å¾— " .. gain)
	end
end)

getInvFunc.OnServerInvoke = function(player)
	local inv = player:FindFirstChild("Inventory")
	local data = {}
	if inv then
		for _, item in pairs(inv:GetChildren()) do
			local conf = GameConfig.Weapons[item.Name] or GameConfig.Items[item.Name] or GameConfig.Skin[item.Name]
			if conf then
				table.insert(data, {
					RealName = item.Name,
					DisplayName = conf.DisplayName or item.Name,
					Qty = item.Value,
					Category = conf.Category or "Items",
					ImageId = conf.ImageId,
					Price = conf.Price,
					CanSell = conf.CanSell,
					Rarity = conf.Rarity
				})
			end
		end
	end
	return data
end

-- ==========================================
-- 4. åˆå§‹åŒ–æµç¨‹
-- ==========================================
Players.PlayerAdded:Connect(function(player)
	local inv = player:FindFirstChild("Inventory") or Instance.new("Folder")
	inv.Name = "Inventory"
	inv.Parent = player

	player.CharacterAdded:Connect(function(char)
		task.wait(1) 
		bindInventorySync(player)
	end)

	-- åˆæ¬¡è¿›å…¥ä¹Ÿç»‘å®š
	bindInventorySync(player)
end)

print("âœ… [InventorySystem] æœåŠ¡ç«¯é€»è¾‘å°±ç»ª (StarterGear åŒæ­¥ä¿®å¤ç‰ˆ)")