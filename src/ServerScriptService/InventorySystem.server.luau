local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- å¼•å…¥é…ç½®
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- ==========================================
-- 1. è¿œç¨‹æ¥å£åˆå§‹åŒ– (è‡ªåŠ¨ä¿®å¤ç¼ºå¤±çš„ Remote)
-- ==========================================
local function ensureFolder(name)
	local folder = ReplicatedStorage:FindFirstChild(name)
	if not folder then
		folder = Instance.new("Folder")
		folder.Name = name
		folder.Parent = ReplicatedStorage
	end
	return folder
end

local RemoteFunctionFolder = ensureFolder("RemoteFunction")
local RemoteEventFolder = ensureFolder("RemoteEvent")

local function ensureRemoteFunc(name)
	local rf = RemoteFunctionFolder:FindFirstChild(name)
	if not rf then
		rf = Instance.new("RemoteFunction")
		rf.Name = name
		rf.Parent = RemoteFunctionFolder
		print("ğŸ”¨ [InventorySystem] è‡ªåŠ¨åˆ›å»º RemoteFunction: " .. name)
	end
	-- å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœå­˜åœ¨åŒåçš„ RemoteEventï¼Œå°†å…¶åˆ é™¤å¹¶æ›¿æ¢ï¼ˆé˜²æ­¢å†²çªï¼‰
	if rf:IsA("RemoteEvent") then
		rf:Destroy()
		rf = Instance.new("RemoteFunction")
		rf.Name = name
		rf.Parent = RemoteFunctionFolder
		print("â™»ï¸ [InventorySystem] å°†æ—§ RemoteEvent å‡çº§ä¸º RemoteFunction: " .. name)
	end
	return rf
end

local function ensureRemoteEvent(name)
	local re = RemoteEventFolder:FindFirstChild(name)
	if not re then
		re = Instance.new("RemoteEvent")
		re.Name = name
		re.Parent = RemoteEventFolder
		print("ğŸ”¨ [InventorySystem] è‡ªåŠ¨åˆ›å»º RemoteEvent: " .. name)
	end
	return re
end

-- [æ ¸å¿ƒä¿®å¤] åœ¨è¿™é‡Œç»Ÿä¸€åˆ›å»º ShopSystem å’Œ InventorySystem éœ€è¦çš„æ‰€æœ‰æ¥å£
-- è¿™æ · ShopSystem å¯åŠ¨æ—¶å°±èƒ½ç›´æ¥æ‰¾åˆ°å®ƒä»¬ï¼Œä¸ä¼šæŠ¥é”™ Infinite Yield
ensureRemoteFunc("BuyItem")          -- å•†åº—è´­ä¹° (RemoteFunction)
local getInvFunc = ensureRemoteFunc("GetInventoryData") -- è·å–èƒŒåŒ… (RemoteFunction)
local sellEvent = ensureRemoteEvent("SellItem")         -- å‡ºå”®ç‰©å“ (RemoteEvent)


-- ==========================================
-- 2. è·å–èƒŒåŒ…æ•°æ® (æ ¸å¿ƒé€»è¾‘)
-- ==========================================
getInvFunc.OnServerInvoke = function(player)
	local inventory = player:FindFirstChild("Inventory")
	local data = {}

	if inventory then
		for _, itemObj in pairs(inventory:GetChildren()) do
			local itemName = itemObj.Name

			-- æœç´¢æ‰€æœ‰é…ç½®è¡¨ (æ­¦å™¨ã€ç‰©å“ã€çš®è‚¤)
			local itemInfo = GameConfig.Weapons[itemName] 
				or GameConfig.Items[itemName] 
				or GameConfig.Skin[itemName]

			if itemInfo then
				table.insert(data, {
					RealName = itemName,
					DisplayName = itemInfo.DisplayName or itemName,
					Qty = itemObj.Value,
					Price = itemInfo.Price,
					CanSell = itemInfo.CanSell,
					Category = itemInfo.Category or "Item",
					-- å¿…é¡»å‘é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®ï¼šå›¾ç‰‡å’Œç¨€æœ‰åº¦
					ImageId = itemInfo.ImageId, 
					Rarity = itemInfo.Rarity
				})
			end
		end
	end
	return data
end

-- ==========================================
-- 3. å¤„ç†å‡ºå”®è¯·æ±‚
-- ==========================================
sellEvent.OnServerEvent:Connect(function(player, itemName, price, qty)
	local inventory = player:FindFirstChild("Inventory")
	local itemObj = inventory and inventory:FindFirstChild(itemName)

	-- å†æ¬¡æœç´¢é…ç½®
	local itemInfo = GameConfig.Weapons[itemName] 
		or GameConfig.Items[itemName] 
		or GameConfig.Skin[itemName]

	if itemObj and itemInfo then
		if itemInfo.CanSell then
			if itemObj.Value >= qty then
				-- 1. æ‰£é™¤ç‰©å“
				itemObj.Value = itemObj.Value - qty

				-- 2. åŠ é’± (å®‰å…¨èµ·è§ï¼Œä»·æ ¼ç”±æœåŠ¡å™¨é‡æ–°è®¡ç®—ï¼Œå–åŸä»·çš„ 50%)
				local realSellPrice = math.floor((itemInfo.Price or 0) * 0.5) * qty

				local leaderstats = player:FindFirstChild("leaderstats")
				if leaderstats and leaderstats:FindFirstChild("Gold") then
					leaderstats.Gold.Value = leaderstats.Gold.Value + realSellPrice
					print("ğŸ’° [Server] " .. player.Name .. " å‡ºå”®äº† " .. itemName .. " è·å¾—é‡‘å¸: " .. realSellPrice)
				end

				-- 3. å¦‚æœæ•°é‡å½’é›¶ï¼Œåˆ é™¤æ•°æ®å¯¹è±¡
				if itemObj.Value <= 0 then
					itemObj:Destroy()
					-- å¦‚æœæ˜¯æ­¦å™¨ï¼ŒåŒæ—¶ä»èƒŒåŒ…ç§»é™¤å®ä½“å·¥å…·
					if player.Backpack:FindFirstChild(itemName) then
						player.Backpack[itemName]:Destroy()
					end
				end
			else
				warn("âŒ æ•°é‡ä¸è¶³ï¼Œæ— æ³•å‡ºå”®")
			end
		else
			warn("âŒ æ­¤ç‰©å“ä¸å¯å‡ºå”®")
		end
	end
end)

print("âœ… InventorySystem å·²å¯åŠ¨ï¼Œæ‰€æœ‰ Remote æ¥å£å·²å°±ç»ªã€‚")