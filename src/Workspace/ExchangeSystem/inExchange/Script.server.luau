-- ä½ç½®: Workspace -> ExchangeSystem -> (å‡ºå£å¢™éƒ¨ä»¶) -> Script
local triggerPart = script.Parent
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- å¼•ç”¨èµ„æº
local RemoteEventFolder = ReplicatedStorage:WaitForChild("RemoteEvent")
local bossEvent = RemoteEventFolder:WaitForChild("BossBattleEvent") 

-- =================é…ç½®åŒºåŸŸ=================
local folder = script.Parent.Parent 

-- ç¡®ä¿æ–‡ä»¶å¤¹é‡Œæœ‰è¿™ä¸¤ä¸ª Part
local IN_PART_NAME = "InPart" 
local OUT_PART_NAME = "outsidePart"

-- [ä¿®æ”¹] å¼¹çª—æ–‡å­—ï¼šè¯¢é—®æ˜¯å¦ç¦»å¼€
local PROMPT_TEXT = "Do you want to leave the exchange?"
-- =========================================

local inPart = folder:WaitForChild(IN_PART_NAME)
local outPart = folder:WaitForChild(OUT_PART_NAME)

-- â„ï¸ å†»ç»“/è§£å†»å‡½æ•° (ä¿æŒä¸å˜)
local function freezePlayer(player, freeze)
	local char = player.Character
	if char then
		local humanoid = char:FindFirstChild("Humanoid")
		local rootPart = char:FindFirstChild("HumanoidRootPart")

		if humanoid and rootPart then
			if freeze then
				rootPart.Anchored = true 
				humanoid.WalkSpeed = 0
				humanoid.JumpPower = 0
			else
				rootPart.Anchored = false
				humanoid.WalkSpeed = 16 
				humanoid.JumpPower = 50
			end
		end
	end
end

-- 1. ç©å®¶è§¦ç¢°è¯†åˆ«å¢™
triggerPart.Touched:Connect(function(hit)
	local player = Players:GetPlayerFromCharacter(hit.Parent)

	-- é˜²æ­¢é‡å¤è§¦å‘
	if player and not player:GetAttribute("IsAskingExchange") then

		-- A. ç«‹å³å†»ç»“
		player:SetAttribute("IsAskingExchange", true)
		freezePlayer(player, true) 

		-- B. å‘é€å¼¹çª— (æ˜¾ç¤ºæ–°çš„è‹±æ–‡æç¤º)
		bossEvent:FireClient(player, "ASK_FIGHT", PROMPT_TEXT)

		-- C. ç›‘å¬å›å¤
		local connection
		connection = bossEvent.OnServerEvent:Connect(function(client, response)
			if client == player then
				if response == "YES" then
					print("ğŸƒ " .. player.Name .. " ç¦»å¼€äº¤æ˜“æ‰€")

					-- è§£å†»
					freezePlayer(player, false)

					-- [ä¿®æ”¹] YES -> ä¼ é€åˆ°å¤–é¢ (Outside)
					if player.Character then
						player.Character:PivotTo(outPart.CFrame)
					end

				elseif response == "NO" then
					print("ğŸ  " .. player.Name .. " å†³å®šç•™ä¸‹")

					-- è§£å†»
					freezePlayer(player, false)

					-- [ä¿®æ”¹] NO -> ä¼ é€åˆ°é‡Œé¢ (Inside)
					-- é˜²æ­¢ç©å®¶å¡åœ¨å¢™é‡Œï¼ŒæŠŠä»–ä¼ å›äº¤æ˜“æ‰€å†…éƒ¨å®‰å…¨ç‚¹
					if player.Character then
						player.Character:PivotTo(inPart.CFrame)
					end
				end

				-- æ¸…ç†çŠ¶æ€
				player:SetAttribute("IsAskingExchange", nil)
				if connection then connection:Disconnect() end
			end
		end)

		-- D. è¶…æ—¶å¤„ç† (10ç§’ä¸é€‰è‡ªåŠ¨ç•™åœ¨é‡Œé¢)
		task.delay(10, function() 
			if player:GetAttribute("IsAskingExchange") then
				freezePlayer(player, false)
				player:SetAttribute("IsAskingExchange", nil)
				if connection then connection:Disconnect() end

				-- [ä¿®æ”¹] è¶…æ—¶é»˜è®¤ç•™åœ¨é‡Œé¢ (InPart)
				if player.Character then
					player.Character:PivotTo(inPart.CFrame)
				end
			end
		end)
	end
end)