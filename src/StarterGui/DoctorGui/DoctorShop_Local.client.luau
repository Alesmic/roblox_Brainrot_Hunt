-- ä½ç½®: StarterGui -> DoctorGui -> DoctorShop_Local
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local gui = script.Parent
local frame = gui:WaitForChild("MainFrame")
local closeBtn = frame:WaitForChild("CloseButton")
local Buy = frame:WaitForChild("BuyTextButton")
local LimitLabel = frame:WaitForChild("LimitLabel") -- [æ–°å¢] è·å–é™è´­æ ‡ç­¾

-- ç‰©å“é…ç½®
local ITEM_NAME = "Medpack" 
local ITEM_COST = 20
local MAX_LIMIT = 3

-- å¼•ç”¨ RemoteEvents
local RemoteEventFolder = ReplicatedStorage:WaitForChild("RemoteEvent")
local ToggleWindow = RemoteEventFolder:WaitForChild("ToggleHealerWindow") 
local PurchaseItem = RemoteEventFolder:WaitForChild("PurchaseItem") 

-- ==========================================
-- [æ ¸å¿ƒåŠŸèƒ½] æ›´æ–°é™è´­æ˜¾ç¤ºæ–‡å­—
-- ==========================================
local function updateLimitDisplay()
	-- 1. æŸ¥æ‰¾ç©å®¶èƒŒåŒ…æ•°æ®
	local inventory = player:FindFirstChild("Inventory")
	local count = 0

	if inventory then
		local itemData = inventory:FindFirstChild(ITEM_NAME)
		if itemData then
			count = itemData.Value
		end
	end

	-- 2. æ›´æ–°æ–‡å­—
	LimitLabel.Text = "é™ " .. count .. "/" .. MAX_LIMIT .. " ä¸ª"

	-- 3. (å¯é€‰) å¦‚æœæ»¡äº†ï¼ŒæŠŠæŒ‰é’®å˜ç°æˆ–å˜çº¢
	if count >= MAX_LIMIT then
		LimitLabel.TextColor3 = Color3.fromRGB(255, 0, 0) -- çº¢è‰²è­¦å‘Š
		Buy.Text = "å·²è¾¾ä¸Šé™"
		Buy.BackgroundColor3 = Color3.fromRGB(100, 100, 100) -- ç°è‰²æŒ‰é’®
	else
		LimitLabel.TextColor3 = Color3.fromRGB(0, 0, 0) -- æ­£å¸¸é¢œè‰²
		Buy.Text = "Buy " .. ITEM_NAME .. " ($" .. ITEM_COST .. ")"
		Buy.BackgroundColor3 = Color3.fromRGB(46, 204, 113) -- ç»¿è‰²æŒ‰é’®
	end
end

-- ==========================================
-- 1. æ”¶åˆ°æ‰“å¼€ä¿¡å·
-- ==========================================
ToggleWindow.OnClientEvent:Connect(function()
	print("âœ… åŒ»ç”Ÿå•†åº—å·²å¼€å¯ï¼") 
	frame.Visible = true

	-- [å…³é”®] æ‰“å¼€æ—¶ç«‹å³æ›´æ–°ä¸€æ¬¡æ•°é‡æ˜¾ç¤º
	updateLimitDisplay()

	-- [å…³é”®] å¼€å¯å®æ—¶ç›‘å¬ï¼šä¸€æ—¦ inventory é‡Œçš„ Medpack æ•°é‡å˜åŒ–ï¼Œç«‹å³åˆ·æ–° UI
	-- è¿™æ ·æ— è®ºæ˜¯åˆšä¹°å®Œï¼Œè¿˜æ˜¯ç”¨æ‰äº†ä¸€ä¸ªï¼ŒUI éƒ½ä¼šè‡ªåŠ¨å˜
	local inventory = player:WaitForChild("Inventory")
	local itemData = inventory:FindFirstChild(ITEM_NAME)

	-- å¦‚æœè¿˜æ²¡æœ‰è¿™ä¸ªç‰©å“æ•°æ®(è¿˜æ²¡ä¹°è¿‡)ï¼Œå°±ç›‘å¬ Inventory æ–‡ä»¶å¤¹çš„æ·»åŠ äº‹ä»¶
	if not itemData then
		local conn
		conn = inventory.ChildAdded:Connect(function(child)
			if child.Name == ITEM_NAME then
				updateLimitDisplay()
				-- æ‰¾åˆ°åï¼Œè½¬ä¸ºç›‘å¬è¿™ä¸ª Value çš„å˜åŒ–
				child.Changed:Connect(updateLimitDisplay)
				conn:Disconnect() -- æ–­å¼€ ChildAdded ç›‘å¬
			end
		end)
	else
		-- å¦‚æœå·²ç»æœ‰äº†ï¼Œç›´æ¥ç›‘å¬æ•°å€¼å˜åŒ–
		itemData.Changed:Connect(updateLimitDisplay)
	end

	pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, false) end)
	UserInputService.MouseBehavior = Enum.MouseBehavior.Default
end)

-- ==========================================
-- 2. ç‚¹å‡»å…³é—­æŒ‰é’®
-- ==========================================
closeBtn.MouseButton1Click:Connect(function()
	frame.Visible = false
	pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, true) end)
end)

-- ==========================================
-- 3. ç‚¹å‡»è´­ä¹°æŒ‰é’®
-- ==========================================
Buy.MouseButton1Click:Connect(function()
	-- å‰ç«¯å…ˆåšä¸ªç®€å•åˆ¤æ–­ï¼Œé˜²æ­¢æ‰‹æ»‘
	if Buy.Text == "å·²è¾¾ä¸Šé™" then return end

	print("ğŸ–¥ï¸ [å®¢æˆ·ç«¯] è¯·æ±‚è´­ä¹°: " .. ITEM_NAME)
	PurchaseItem:FireServer(ITEM_NAME, ITEM_COST)
end)