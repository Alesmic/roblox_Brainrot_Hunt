local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

print("ğŸ”µ [HealthHUD] UI è„šæœ¬å¼€å§‹è¿è¡Œ...")

-- ==========================================
-- 1. åˆ›å»ºä¸» ScreenGui
-- ==========================================
local screenGui = playerGui:FindFirstChild("StatusHUD")
if screenGui then screenGui:Destroy() end -- é˜²æ­¢é‡å¤ï¼Œå…ˆåˆ æ—§çš„

screenGui = Instance.new("ScreenGui")
screenGui.Name = "StatusHUD"
screenGui.ResetOnSpawn = false -- æ­»äº¡ä¸é‡ç½®
screenGui.DisplayOrder = 100
screenGui.Parent = playerGui

-- ==========================================
-- 2. è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºè¿›åº¦æ¡ (UI å·¥å‚)
-- ==========================================
local function createBar(name, position, color, defaultText)
	-- èƒŒæ™¯å®¹å™¨
	local bgFrame = Instance.new("Frame")
	bgFrame.Name = name .. "Background"
	bgFrame.Size = UDim2.new(0, 300, 0, 22) --ç¨å¾®å˜ç»†ä¸€ç‚¹
	bgFrame.Position = position
	bgFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20) -- æ·±é»‘èƒŒæ™¯
	bgFrame.BorderSizePixel = 0
	bgFrame.Parent = screenGui

	-- åœ†è§’
	local uicorner = Instance.new("UICorner")
	uicorner.CornerRadius = UDim.new(0, 6)
	uicorner.Parent = bgFrame

	-- å¡«å……æ¡
	local fillFrame = Instance.new("Frame")
	fillFrame.Name = "Fill"
	fillFrame.Size = UDim2.new(0, 0, 1, 0) -- åˆå§‹ 0
	fillFrame.BackgroundColor3 = color
	fillFrame.BorderSizePixel = 0
	fillFrame.ZIndex = 2
	fillFrame.Parent = bgFrame

	local fillCorner = uicorner:Clone()
	fillCorner.Parent = fillFrame

	-- æ–‡æœ¬æ ‡ç­¾
	local textLabel = Instance.new("TextLabel")
	textLabel.Name = "Text"
	textLabel.Size = UDim2.new(1, 0, 1, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.TextColor3 = Color3.new(1, 1, 1)
	textLabel.Font = Enum.Font.GothamBold
	textLabel.TextSize = 12
	textLabel.TextStrokeTransparency = 0.5
	textLabel.Text = defaultText or "Loading..."
	textLabel.ZIndex = 3
	textLabel.Parent = bgFrame

	return bgFrame, fillFrame, textLabel
end

-- ==========================================
-- 3. åˆ›å»ºè¡€æ¡ (Health Bar)
-- ==========================================
-- [ä¿®æ”¹] ä½ç½®å‘ä¸Šæï¼šä» 0.85 æ”¹ä¸º 0.82 (é˜²æ­¢è¢«åº•éƒ¨é®æŒ¡)
local healthPos = UDim2.new(0.5, -150, 0.82, 0) 
local healthBg, healthFill, healthText = createBar("HealthBar", healthPos, Color3.fromRGB(231, 76, 60), "HP: -- / --") 

-- ==========================================
-- 4. åˆ›å»ºç»éªŒæ¡ (Experience Bar)
-- ==========================================
-- [ä¿®æ”¹] ä½ç½®ç´§è´´è¡€æ¡ä¸‹æ–¹ï¼šYè½´åç§» 26 åƒç´ 
local expPos = UDim2.new(0.5, -150, 0.82, 26) 
-- æµ…è“è‰²
local expBg, expFill, expText = createBar("ExpBar", expPos, Color3.fromRGB(52, 152, 219), "LV. 1 | 0 / 100") 

-- ==========================================
-- 5. æ›´æ–°é€»è¾‘
-- ==========================================

-- A. æ›´æ–°è¡€é‡
local function updateHealth()
	local char = player.Character
	local humanoid = char and char:FindFirstChild("Humanoid")

	if humanoid then
		local hp = math.max(0, math.floor(humanoid.Health))
		local maxHp = math.floor(humanoid.MaxHealth)

		TweenService:Create(healthFill, TweenInfo.new(0.2, Enum.EasingStyle.Quad), {
			Size = UDim2.new(hp / maxHp, 0, 1, 0)
		}):Play()

		healthText.Text = "HP: " .. hp .. " / " .. maxHp
	end
end

-- B. æ›´æ–°ç»éªŒå€¼
local function updateExp()
	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then return end

	local levelVal = leaderstats:FindFirstChild("Level")
	local expVal = leaderstats:FindFirstChild("Experience") -- ç¡®è®¤è¿™é‡Œæ˜¯ Experience

	if levelVal and expVal then
		local currentLevel = levelVal.Value
		local currentExp = expVal.Value

		-- è·å–å‡çº§æ‰€éœ€ç»éªŒ
		local requiredExp = GameConfig.Leveling.GetXpRequired(currentLevel)
		if requiredExp <= 0 then requiredExp = 1 end

		local progress = math.clamp(currentExp / requiredExp, 0, 1)

		TweenService:Create(expFill, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
			Size = UDim2.new(progress, 0, 1, 0)
		}):Play()

		expText.Text = "LV. " .. currentLevel .. " | " .. currentExp .. " / " .. requiredExp
	end
end

-- ==========================================
-- 6. äº‹ä»¶ç›‘å¬
-- ==========================================

player.CharacterAdded:Connect(function(char)
	local humanoid = char:WaitForChild("Humanoid", 10)
	if humanoid then
		humanoid.HealthChanged:Connect(updateHealth)
		humanoid:GetPropertyChangedSignal("MaxHealth"):Connect(updateHealth)
		updateHealth()
	end
end)

-- åˆå§‹è§’è‰²æ£€æŸ¥
if player.Character then
	local hum = player.Character:FindFirstChild("Humanoid")
	if hum then
		hum.HealthChanged:Connect(updateHealth)
		updateHealth()
	end
end

-- å¯åŠ¨æ•°æ®ç›‘å¬ (ä½¿ç”¨å¾ªç¯é‡è¯•ï¼Œç¡®ä¿èƒ½è¿ä¸Š)
task.spawn(function()
	print("ğŸ”µ [HealthHUD] ç­‰å¾… leaderstats æ•°æ®...")

	-- æ— é™ç­‰å¾…ç›´åˆ°åŠ è½½å‡ºæ¥ï¼Œé˜²æ­¢è¶…æ—¶å¤±æ•ˆ
	local leaderstats = player:WaitForChild("leaderstats", 9999) 
	print("ğŸ”µ [HealthHUD] æ‰¾åˆ° leaderstats!")

	local levelStat = leaderstats:WaitForChild("Level", 9999)
	local expStat = leaderstats:WaitForChild("Experience", 10) 

	if not expStat then
		warn("âŒ [HealthHUD] æ²¡æœ‰æ‰¾åˆ° 'Experience' å±æ€§ï¼è¯·æ£€æŸ¥ PlayerManager è„šæœ¬ï¼")
		-- å°è¯•ç”¨ Instance.new åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„é˜²æ­¢æŠ¥é”™ (ä»…å®¢æˆ·ç«¯)
		return
	end

	print("ğŸ”µ [HealthHUD] æ•°æ®è¿æ¥æˆåŠŸï¼Œæ›´æ–° UI")
	levelStat.Changed:Connect(updateExp)
	expStat.Changed:Connect(updateExp)
	updateExp()
end)