local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- ==========================================
-- 1. åˆ›å»º UI (ä¾§è¾¹æ  + èƒœåˆ©å¤§å­—)
-- ==========================================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "QuestTrackerUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- A. ä¾§è¾¹æ  (ä»»åŠ¡è¿½è¸ª - ä¿æŒåŸæœ‰é£æ ¼ä½†ä¼˜åŒ–)
local trackerFrame = Instance.new("Frame")
trackerFrame.Name = "TrackerFrame"
trackerFrame.Size = UDim2.new(0, 220, 0, 100)
trackerFrame.Position = UDim2.new(1, -240, 0.4, 0) -- å±å¹•å³ä¾§
trackerFrame.BackgroundTransparency = 0.5
trackerFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
trackerFrame.BorderSizePixel = 0
trackerFrame.Parent = screenGui
-- ç»™ä¾§è¾¹æ åŠ ä¸ªåœ†è§’
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 8)
uiCorner.Parent = trackerFrame

local trackerTitle = Instance.new("TextLabel")
trackerTitle.Size = UDim2.new(1, -10, 0, 25)
trackerTitle.Position = UDim2.new(0, 10, 0, 5)
trackerTitle.BackgroundTransparency = 1
trackerTitle.Text = "Current Quest"
trackerTitle.TextColor3 = Color3.new(1, 1, 1)
trackerTitle.Font = Enum.Font.GothamBold
trackerTitle.TextSize = 16
trackerTitle.TextXAlignment = Enum.TextXAlignment.Left
trackerTitle.Parent = trackerFrame

local questLabel = Instance.new("TextLabel")
questLabel.Name = "QuestText"
questLabel.Size = UDim2.new(1, -20, 1, -35)
questLabel.Position = UDim2.new(0, 10, 0, 30)
questLabel.BackgroundTransparency = 1
questLabel.Text = "Loading..."
questLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
questLabel.Font = Enum.Font.Gotham
questLabel.TextSize = 14
questLabel.TextWrapped = true
questLabel.TextXAlignment = Enum.TextXAlignment.Left
questLabel.TextYAlignment = Enum.TextYAlignment.Top
questLabel.Parent = trackerFrame

-- B. [æ–°å¢] èƒœåˆ©å¤§å­— UI (ä»¿ç…§ Boss èƒœåˆ©)
local victoryLabel = Instance.new("TextLabel")
victoryLabel.Name = "QuestVictoryLabel"
victoryLabel.Size = UDim2.new(1, 0, 0.2, 0)
victoryLabel.Position = UDim2.new(0, 0, 0.3, 0) -- å±å¹•ä¸­å¤®åä¸Š
victoryLabel.BackgroundTransparency = 1
victoryLabel.Text = "QUEST COMPLETED!"
victoryLabel.TextColor3 = Color3.fromRGB(255, 215, 0) -- é‡‘è‰²
victoryLabel.Font = Enum.Font.FredokaOne -- å¡é€šç²—ä½“ï¼Œå¾ˆé†’ç›®
victoryLabel.TextSize = 60
victoryLabel.TextStrokeTransparency = 0 -- é»‘è‰²æè¾¹
victoryLabel.TextStrokeColor3 = Color3.new(0,0,0)
victoryLabel.Visible = false -- é»˜è®¤éšè—
victoryLabel.ZIndex = 10 -- ä¿è¯åœ¨æœ€ä¸Šå±‚
victoryLabel.Parent = screenGui

-- ==========================================
-- 2. é€»è¾‘å¤„ç†
-- ==========================================
local completedQuestsCache = {} -- ç¼“å­˜è¡¨ï¼šè®°å½•å“ªäº›ä»»åŠ¡å·²ç»å¼¹è¿‡çª—äº†

-- æ˜¾ç¤ºå¤§å­—åŠ¨ç”»å‡½æ•°
local function showVictoryAnimation(text)
	victoryLabel.Text = text
	victoryLabel.Visible = true
	victoryLabel.TextTransparency = 0
	victoryLabel.TextStrokeTransparency = 0
	victoryLabel.Position = UDim2.new(0, 0, 0.4, 0) -- èµ·å§‹ä½ç½® (ç¨ä½ä¸€ç‚¹)

	-- 1. å‘ä¸Šæµ®åŠ¨ + å¼¹æ€§è¿›å…¥
	local tweenIn = TweenService:Create(victoryLabel, TweenInfo.new(0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.new(0, 0, 0.3, 0)
	})
	tweenIn:Play()

	-- æ’­æ”¾ä¸ªç®€å•çš„éŸ³æ•ˆ (é€šç”¨æç¤ºéŸ³)
	local sound = Instance.new("Sound", workspace)
	sound.SoundId = "rbxassetid://12221967" -- æ¬¢å‘¼/æç¤ºéŸ³æ•ˆ
	sound.Volume = 1
	sound:Play()
	task.delay(2, function() sound:Destroy() end)

	-- 2. åœç•™ 3 ç§’å -> æ·¡å‡º + ç»§ç»­ä¸Šæµ®
	task.delay(3, function()
		local tweenOut = TweenService:Create(victoryLabel, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
			TextTransparency = 1,
			TextStrokeTransparency = 1,
			Position = UDim2.new(0, 0, 0.2, 0) 
		})
		tweenOut:Play()

		tweenOut.Completed:Connect(function()
			victoryLabel.Visible = false
		end)
	end)
end

-- æ›´æ–°ä»»åŠ¡è¿½è¸ªå™¨
local function updateQuestTracker()
	local hiddenStats = player:FindFirstChild("HiddenStats")
	if not hiddenStats then 
		questLabel.Text = "No data..."
		return 
	end

	local activeQuestText = "No active quests."
	local hasActive = false

	-- éå†é…ç½®ä¸­çš„æ‰€æœ‰ä»»åŠ¡
	if GameConfig.Quests then
		for questID, questData in pairs(GameConfig.Quests) do
			local questStatName = "Quest_" .. questID
			local statValue = hiddenStats:FindFirstChild(questStatName)

			-- å¦‚æœç©å®¶æœ‰è¿™ä¸ªä»»åŠ¡çš„è¿›åº¦æ•°æ®
			if statValue then
				local current = statValue.Value
				local target = questData.TargetCount

				-- æ£€æŸ¥æ˜¯å¦å®Œæˆ
				if current >= target then
					-- [å…³é”®] å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ£€æµ‹åˆ°å®Œæˆï¼Œå°±å¼¹çª—
					if not completedQuestsCache[questID] then
						completedQuestsCache[questID] = true
						print("ğŸ‰ Quest Completed: " .. questID)
						showVictoryAnimation("QUEST COMPLETED!")
					end
				else
					-- å¦‚æœè¿˜æ²¡å®Œæˆï¼Œå¹¶ä¸”è¿˜æ²¡æ˜¾ç¤ºå…¶ä»–ä»»åŠ¡ï¼Œå°±æ˜¾ç¤ºåœ¨è¿™ä¸ªä¾§è¾¹æ 
					-- (å¦‚æœä½ æƒ³æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡ï¼Œå¯ä»¥æ‹¼æ¥å­—ç¬¦ä¸²)
					if not hasActive then
						-- åªæœ‰æ²¡å®Œæˆçš„ä»»åŠ¡æ‰æ˜¾ç¤ºåœ¨ä¾§è¾¹æ 
						activeQuestText = string.format("%s\n\nğŸ¯ Progress: %d / %d\nğŸ’° Reward: %d Gold", 
							questData.Name or "Unknown Quest", 
							current, 
							target,
							questData.GoldReward or 0
						)
						hasActive = true
						-- è¿™é‡Œä¸returnï¼Œç»§ç»­å¾ªç¯ï¼Œä»¥å…æ¼æ‰å…¶ä»–ä»»åŠ¡çš„å®Œæˆæ£€æµ‹
					end
					-- æ ‡è®°è¿™ä¸ªä»»åŠ¡æœªå®Œæˆï¼Œé˜²æ­¢ä»¥åé‡å¤å¼¹çª—é€»è¾‘å‡ºé”™
					completedQuestsCache[questID] = false 
				end
			end
		end
	end

	questLabel.Text = activeQuestText
end

-- ==========================================
-- 3. å¯åŠ¨ç›‘å¬
-- ==========================================
task.spawn(function()
	local hiddenStats = player:WaitForChild("HiddenStats", 10)
	if hiddenStats then
		print("âœ… [QuestTracker] Connected to HiddenStats")

		-- ç›‘å¬æ–°ä»»åŠ¡æ·»åŠ 
		hiddenStats.ChildAdded:Connect(function(child)
			if child:IsA("IntValue") then
				child.Changed:Connect(updateQuestTracker)
				updateQuestTracker()
			end
		end)

		-- ç›‘å¬ç°æœ‰ä»»åŠ¡å˜åŒ–
		for _, child in pairs(hiddenStats:GetChildren()) do
			if child:IsA("IntValue") then
				child.Changed:Connect(updateQuestTracker)
			end
		end

		-- åˆå§‹åˆ·æ–°
		updateQuestTracker()
	else
		warn("âŒ [QuestTracker] Could not find HiddenStats")
	end
end)