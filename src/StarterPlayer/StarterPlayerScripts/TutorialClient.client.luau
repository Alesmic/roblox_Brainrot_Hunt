local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local hiddenStats = player:WaitForChild("HiddenStats")

-- ==========================================
-- 1. èµ„æºå¼•ç”¨
-- ==========================================
-- ç¡®ä¿ NPC åå­—å’Œ Workspace é‡Œçš„å®Œå…¨ä¸€è‡´
local npcFolder = workspace:WaitForChild("NPCs") 
local npc = npcFolder:WaitForChild("Tung Tung Sahur") 
local rootPart = npc:WaitForChild("HumanoidRootPart")
local prompt = npc:WaitForChild("ProximityPrompt") 

-- è·å–å¤´éƒ¨
local head = npc:WaitForChild("Head")

-- [æ ¸å¿ƒä¿®å¤] å‡†ç¡®è·å– 3D æ„Ÿå¹å·éƒ¨ä»¶ (QuestMarker/Union)
local questMarkerModel = head:WaitForChild("QuestMarker", 5) -- ç­‰å¾…æœ€å¤š5ç§’
local questUnion = nil

if questMarkerModel then
	questUnion = questMarkerModel:FindFirstChild("Union")
	if not questUnion then
		warn("âš ï¸ [TutorialClient] æ‰¾åˆ°äº† QuestMarker ä½†æ²¡æ‰¾åˆ° Unionï¼Œè¯·æ£€æŸ¥å‘½åï¼")
	end
else
	warn("âš ï¸ [TutorialClient] åœ¨ Head ä¸‹æ²¡æ‰¾åˆ° QuestMarker æ–‡ä»¶å¤¹/æ¨¡å‹")
end

-- å…¼å®¹æ—§é€»è¾‘ï¼šå¦‚æœæœ‰åä¸º QuestIcon çš„ BillboardGui ä¹Ÿè·å–ä¸€ä¸‹
local guiIcon = head:FindFirstChild("QuestIcon") or head:FindFirstChild("BillboardGui")

-- ğŸ“¡ è·å–è¿œç¨‹äº‹ä»¶
local RemoteEventFolder = ReplicatedStorage:WaitForChild("RemoteEvent")
local finishTalkEvent = RemoteEventFolder:WaitForChild("FinishTutorialTalk") 

-- ==========================================
-- 2. å¯¹è¯ UI ç”Ÿæˆ
-- ==========================================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DialogueUI"
screenGui.ResetOnSpawn = false
screenGui.DisplayOrder = 100
screenGui.Parent = playerGui

local dialogFrame = Instance.new("Frame")
dialogFrame.Name = "DialogFrame"
dialogFrame.Size = UDim2.new(0.6, 0, 0.25, 0)
dialogFrame.Position = UDim2.new(0.2, 0, 0.7, 0)
dialogFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
dialogFrame.BorderSizePixel = 2
dialogFrame.BorderColor3 = Color3.fromRGB(255, 215, 0)
dialogFrame.Visible = false
dialogFrame.Parent = screenGui

local nameLabel = Instance.new("TextLabel")
nameLabel.Text = "Tung Tung Sahur"
nameLabel.Size = UDim2.new(0.3, 0, 0.3, 0)
nameLabel.Position = UDim2.new(0, 10, -0.35, 0)
nameLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
nameLabel.BackgroundTransparency = 1
nameLabel.Font = Enum.Font.FredokaOne
nameLabel.TextSize = 24
nameLabel.TextXAlignment = Enum.TextXAlignment.Left
nameLabel.Parent = dialogFrame

local contentLabel = Instance.new("TextLabel")
contentLabel.Size = UDim2.new(0.95, 0, 0.8, 0)
contentLabel.Position = UDim2.new(0.025, 0, 0.1, 0)
contentLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
contentLabel.BackgroundTransparency = 1
contentLabel.Font = Enum.Font.SourceSans
contentLabel.TextSize = 22
contentLabel.TextXAlignment = Enum.TextXAlignment.Left
contentLabel.TextYAlignment = Enum.TextYAlignment.Top
contentLabel.TextWrapped = true
contentLabel.Parent = dialogFrame

local continueLabel = Instance.new("TextLabel")
continueLabel.Text = "[Click to Continue]"
continueLabel.Size = UDim2.new(0.2, 0, 0.2, 0)
continueLabel.Position = UDim2.new(0.8, 0, 0.8, 0)
continueLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
continueLabel.BackgroundTransparency = 1
continueLabel.Font = Enum.Font.SourceSansItalic
continueLabel.TextSize = 18
continueLabel.Parent = dialogFrame

-- ==========================================
-- 3. é€»è¾‘æ§åˆ¶
-- ==========================================
local isTalking = false
local QUEST_ID = "Quest_SamuraiSlayer"

local function typeWrite(text)
	contentLabel.Text = text
	contentLabel.MaxVisibleGraphemes = 0
	for i = 1, #text do
		contentLabel.MaxVisibleGraphemes = i
		task.wait(0.02)
	end
end

-- [è¾…åŠ©å‡½æ•°] æ§åˆ¶å›¾æ ‡æ˜¾ç¤º/éšè—
local function setIconVisible(isVisible)
	-- 1. å¤„ç† 3D éƒ¨ä»¶ (Union)
	if questUnion then
		-- å¦‚æœæ˜¯éƒ¨ä»¶ï¼Œç”¨ Transparency æ§åˆ¶ (0=æ˜¾ç¤º, 1=éšè—)
		questUnion.Transparency = isVisible and 0 or 1
	end

	-- 2. å¤„ç† GUI (å…¼å®¹æ—§ç‰ˆ)
	if guiIcon then
		guiIcon.Enabled = isVisible
	end
end

-- æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
local function checkQuestStatus()
	local qVal = hiddenStats:FindFirstChild(QUEST_ID)

	-- æ£€æŸ¥â€œæ•™ç¨‹å®Œæˆâ€æ ‡è®°
	local isTutorialDone = false
	if hiddenStats:FindFirstChild("TutorialCompleted") and hiddenStats.TutorialCompleted.Value == true then
		isTutorialDone = true
	end

	-- 1. å¦‚æœæ•™ç¨‹å·²å®Œæˆ -> å½»åº•å…³é—­
	if isTutorialDone then
		prompt.Enabled = false
		setIconVisible(false) -- éšè—æ„Ÿå¹å·
		return
	end

	-- 2. å¦‚æœä»»åŠ¡å·²å®Œæˆ (ä½†æ•™ç¨‹çŠ¶æ€å¯èƒ½è¿˜æ²¡æ›´æ–°) -> æš‚æ—¶å…³é—­
	if qVal and qVal.Value >= 10 then
		prompt.Enabled = false 
		setIconVisible(false) -- éšè—æ„Ÿå¹å·
	else
		-- 3. å…¶ä»–æƒ…å†µ (æ–°ç©å®¶/ä»»åŠ¡è¿›è¡Œä¸­) -> å¼€å¯
		prompt.Enabled = true
		setIconVisible(true)  -- æ˜¾ç¤ºæ„Ÿå¹å·
	end
end

-- å¼€å§‹å¯¹è¯
local function startDialog()
	if isTalking then return end

	-- [åŒé‡ä¿é™©] å¦‚æœæ•™ç¨‹åšå®Œäº†ï¼Œç¦æ­¢å¼€å§‹å¯¹è¯
	if hiddenStats:FindFirstChild("TutorialCompleted") and hiddenStats.TutorialCompleted.Value == true then
		return
	end

	isTalking = true
	dialogFrame.Visible = true

	local qVal = hiddenStats:FindFirstChild(QUEST_ID)

	if not qVal then
		-- A. ã€æ–°ç©å®¶ã€‘
		typeWrite("Hello traveler! The village is in danger.")
		dialogFrame.InputBegan:Wait()

		typeWrite("Here, take this weapon. It's dangerous out there.")
		dialogFrame.InputBegan:Wait()

		typeWrite("Defeat 10 Samurai for me, and I will reward you.")
		dialogFrame.InputBegan:Wait()

		print("ğŸ“¡ [å®¢æˆ·ç«¯] è¯·æ±‚æœåŠ¡å™¨å‘æ”¾å¥–åŠ±...")
		finishTalkEvent:FireServer()

	elseif qVal.Value < 10 then
		-- B. ã€ä»»åŠ¡è¿›è¡Œä¸­ã€‘
		typeWrite("You have defeated " .. qVal.Value .. " / 10 Samurai.")
		dialogFrame.InputBegan:Wait()
		typeWrite("Keep going! I need them gone.")
		dialogFrame.InputBegan:Wait()
	else
		-- C. ã€ä»»åŠ¡å·²å®Œæˆã€‘
		typeWrite("You are a true hero! Thank you!")
		dialogFrame.InputBegan:Wait()
	end

	dialogFrame.Visible = false
	isTalking = false
end

-- ==========================================
-- 4. ç›‘å¬ä¸åˆå§‹åŒ–
-- ==========================================
prompt.Triggered:Connect(startDialog)

-- åˆå§‹æ£€æŸ¥
task.wait(1)
checkQuestStatus()

-- ç›‘å¬ HiddenStats
hiddenStats.ChildAdded:Connect(function(child)
	if child.Name == QUEST_ID or child.Name == "TutorialCompleted" then
		checkQuestStatus()
		child.Changed:Connect(checkQuestStatus)
	end
end)

if hiddenStats:FindFirstChild(QUEST_ID) then
	hiddenStats[QUEST_ID].Changed:Connect(checkQuestStatus)
end

if hiddenStats:FindFirstChild("TutorialCompleted") then
	hiddenStats.TutorialCompleted.Changed:Connect(checkQuestStatus)
end