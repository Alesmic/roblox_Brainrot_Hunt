local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local hiddenStats = player:WaitForChild("HiddenStats")

-- ==========================================
-- 1. èµ„æºå¼•ç”¨
-- ==========================================
-- ç¡®ä¿ NPC åå­—å’Œ Workspace é‡Œçš„å®Œå…¨ä¸€è‡´
local npcFolder = workspace:WaitForChild("NPCs") 
local npc = npcFolder:WaitForChild("Tung Tung Sahur") 
local rootPart = npc:WaitForChild("HumanoidRootPart")
local prompt = npc:WaitForChild("ProximityPrompt") 

-- è·å–å¤´é¡¶å›¾æ ‡ (å¦‚æœæœ‰çš„è¯ï¼Œæ²¡æœ‰ä¹Ÿä¸å½±å“è¿è¡Œ)
local head = npc:WaitForChild("Head")
local questIcon = head:FindFirstChild("QuestIcon") or head:FindFirstChild("BillboardGui")

-- ğŸ“¡ è·å–è¿œç¨‹äº‹ä»¶ (è¿™æ˜¯é€šçŸ¥æœåŠ¡å™¨å‘æ­¦å™¨çš„å…³é”®)
local RemoteEventFolder = ReplicatedStorage:WaitForChild("RemoteEvent")
local finishTalkEvent = RemoteEventFolder:WaitForChild("FinishTutorialTalk") 

-- ==========================================
-- 2. å¯¹è¯ UI ç”Ÿæˆ (é¢œè‰²ä¿®å¤ç‰ˆ)
-- ==========================================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DialogueUI"
screenGui.ResetOnSpawn = false
screenGui.DisplayOrder = 100
screenGui.Parent = playerGui

local dialogFrame = Instance.new("Frame")
dialogFrame.Name = "DialogFrame"
dialogFrame.Size = UDim2.new(0.6, 0, 0.25, 0)
dialogFrame.Position = UDim2.new(0.2, 0, 0.7, 0)
dialogFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
dialogFrame.BorderSizePixel = 2
dialogFrame.BorderColor3 = Color3.fromRGB(255, 215, 0)
dialogFrame.Visible = false
dialogFrame.Parent = screenGui

local nameLabel = Instance.new("TextLabel")
nameLabel.Text = "Tung Tung Sahur"
nameLabel.Size = UDim2.new(0.3, 0, 0.3, 0)
nameLabel.Position = UDim2.new(0, 10, -0.35, 0)
nameLabel.TextColor3 = Color3.fromRGB(255, 215, 0) -- é‡‘è‰²
nameLabel.BackgroundTransparency = 1
nameLabel.Font = Enum.Font.FredokaOne
nameLabel.TextSize = 24
nameLabel.TextXAlignment = Enum.TextXAlignment.Left
nameLabel.Parent = dialogFrame

local contentLabel = Instance.new("TextLabel")
contentLabel.Size = UDim2.new(0.95, 0, 0.8, 0)
contentLabel.Position = UDim2.new(0.025, 0, 0.1, 0)
contentLabel.TextColor3 = Color3.fromRGB(255, 255, 255) -- âœ… ä¿®å¤ï¼šä½¿ç”¨ fromRGB é¿å… nil æŠ¥é”™
contentLabel.BackgroundTransparency = 1
contentLabel.Font = Enum.Font.SourceSans
contentLabel.TextSize = 22
contentLabel.TextXAlignment = Enum.TextXAlignment.Left
contentLabel.TextYAlignment = Enum.TextYAlignment.Top
contentLabel.TextWrapped = true
contentLabel.Parent = dialogFrame

local continueLabel = Instance.new("TextLabel")
continueLabel.Text = "[Click to Continue]"
continueLabel.Size = UDim2.new(0.2, 0, 0.2, 0)
continueLabel.Position = UDim2.new(0.8, 0, 0.8, 0)
continueLabel.TextColor3 = Color3.fromRGB(150, 150, 150) -- ç°è‰²
continueLabel.BackgroundTransparency = 1
continueLabel.Font = Enum.Font.SourceSansItalic
continueLabel.TextSize = 18
continueLabel.Parent = dialogFrame

-- ==========================================
-- 3. é€»è¾‘æ§åˆ¶
-- ==========================================
local isTalking = false
local QUEST_ID = "Quest_SamuraiSlayer" -- å¿…é¡»å’ŒæœåŠ¡å™¨å‘çš„ä»»åŠ¡åä¸€è‡´

-- æ‰“å­—æœºæ•ˆæœ
local function typeWrite(text)
	contentLabel.Text = text
	contentLabel.MaxVisibleGraphemes = 0
	for i = 1, #text do
		contentLabel.MaxVisibleGraphemes = i
		task.wait(0.02)
	end
end

-- æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºå¤´é¡¶é—®å·
local function checkQuestStatus()
	local qVal = hiddenStats:FindFirstChild(QUEST_ID)
	if qVal and qVal.Value >= 10 then
		prompt.Enabled = false -- ä»»åŠ¡åšå®Œäº†å°±ä¸èƒ½å¯¹è¯äº†(æˆ–è€…ä½ å¯ä»¥æ”¹æˆäº¤ä»»åŠ¡é€»è¾‘)
		if questIcon then questIcon.Enabled = false end
	else
		prompt.Enabled = true
		if questIcon then questIcon.Enabled = true end
	end
end

-- å¼€å§‹å¯¹è¯
local function startDialog()
	if isTalking then return end
	isTalking = true

	dialogFrame.Visible = true

	local qVal = hiddenStats:FindFirstChild(QUEST_ID)

	if not qVal then
		-- A. ã€æœªæ¥ä»»åŠ¡ã€‘ ç¬¬ä¸€æ¬¡å¯¹è¯
		typeWrite("Hello traveler! The village is in danger.")
		dialogFrame.InputBegan:Wait()

		typeWrite("Here, take this weapon. It's dangerous out there.")
		dialogFrame.InputBegan:Wait()

		typeWrite("Defeat 10 Samurai for me, and I will reward you.")
		dialogFrame.InputBegan:Wait()

		-- ğŸŸ¢ å…³é”®ï¼šå‘Šè¯‰æœåŠ¡å™¨å¯¹è¯ç»“æŸï¼Œå‘æ­¦å™¨ï¼Œå‘ä»»åŠ¡ï¼
		print("ğŸ“¡ [å®¢æˆ·ç«¯] è¯·æ±‚æœåŠ¡å™¨å‘æ”¾å¥–åŠ±...")
		finishTalkEvent:FireServer()

	elseif qVal.Value < 10 then
		-- B. ã€ä»»åŠ¡è¿›è¡Œä¸­ã€‘
		typeWrite("You have defeated " .. qVal.Value .. " / 10 Samurai.")
		dialogFrame.InputBegan:Wait()
		typeWrite("Keep going! I need them gone.")
		dialogFrame.InputBegan:Wait()
	else
		-- C. ã€ä»»åŠ¡å·²å®Œæˆã€‘
		typeWrite("You are a true hero! Thank you!")
		dialogFrame.InputBegan:Wait()
	end

	dialogFrame.Visible = false
	isTalking = false
end

-- ==========================================
-- 4. ç›‘å¬ä¸åˆå§‹åŒ–
-- ==========================================
prompt.Triggered:Connect(startDialog)

-- åˆå§‹æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
task.wait(1)
checkQuestStatus()

-- ç›‘å¬ä»»åŠ¡å˜åŒ– (ä¾‹å¦‚æ‰“å®Œæ€ªè¿›åº¦æ›´æ–°æ—¶)
if hiddenStats:FindFirstChild(QUEST_ID) then
	hiddenStats[QUEST_ID].Changed:Connect(checkQuestStatus)
end

hiddenStats.ChildAdded:Connect(function(child)
	if child.Name == QUEST_ID then
		checkQuestStatus()
		child.Changed:Connect(checkQuestStatus)
	end
end)