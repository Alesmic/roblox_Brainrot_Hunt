-- Sword Script: å¼ºåŒ–ä»»åŠ¡è®¡æ•°ç‰ˆ (Bat PvPä¿®å¤ç‰ˆ)
local Tool = script.Parent
local Handle = Tool:WaitForChild("Handle")
local Players = game:GetService("Players")
local Debris = game:GetService("Debris")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- 1. è·å–é…ç½®
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))
local toolName = Tool.Name
-- å°è¯•è·å– Bat çš„é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
local weaponStats = GameConfig.Weapons[toolName] or GameConfig.Weapons["Bat"] or {Damage = 10}

local BaseDamage = weaponStats.Damage or 10
local SlashDamage = BaseDamage
local LungeDamage = math.floor(BaseDamage * 1.5)
local CurrentDamage = BaseDamage

-- éŸ³æ•ˆ
local BaseUrl = "rbxassetid://"
local function loadSound(name, id)
	local sound = Handle:FindFirstChild(name)
	if not sound then
		sound = Instance.new("Sound")
		sound.Name = name
		sound.SoundId = BaseUrl .. id
		sound.Volume = 0.5
		sound.Parent = Handle
	end
	return sound
end
local Sounds = {
	Slash = loadSound("Slash", "12222216"),
	Lunge = loadSound("Lunge", "12222208"),
	Unsheath = loadSound("Unsheath", "12222225")
}

-- å˜é‡
local ToolEquipped = false
local Character = nil
local Player = nil
local Humanoid = nil

Tool.Enabled = true

-- ==========================================
-- æ ¸å¿ƒåŠŸèƒ½ï¼šæ ‡è®°å‡»æ€è€… (ä»»åŠ¡ç³»ç»Ÿçš„å…³é”®)
-- ==========================================
function TagHumanoid(humanoid, player)
	local creator_tag = Instance.new("ObjectValue")
	creator_tag.Name = "creator"
	creator_tag.Value = player
	-- [ä¼˜åŒ–] å»¶é•¿ Tag æ—¶é—´åˆ° 5 ç§’ï¼Œç¡®ä¿MobHandlerèƒ½è¯»åˆ°
	Debris:AddItem(creator_tag, 5) 
	creator_tag.Parent = humanoid
end

function UntagHumanoid(humanoid)
	for i, v in pairs(humanoid:GetChildren()) do
		if v:IsA("ObjectValue") and v.Name == "creator" then
			v:Destroy()
		end
	end
end

function Blow(Hit)
	if not Hit or not Hit.Parent or not ToolEquipped or not Player then return end

	local targetChar = Hit.Parent
	if targetChar == Character then return end -- ä¸æ‰“è‡ªå·±

	local targetHum = targetChar:FindFirstChild("Humanoid")
	if not targetHum or targetHum.Health <= 0 then return end

	-- ç©å®¶åˆ¤å®šä¸ PvP æ£€æŸ¥
	local targetPlayer = Players:GetPlayerFromCharacter(targetChar)
	if targetPlayer then
		-- 1. é˜Ÿå‹åˆ¤å®š
		if targetPlayer == Player then return end
		if targetPlayer.Team and targetPlayer.Team == Player.Team then return end

		-- ==========================================
		-- [æ–°å¢] PvP æ¨¡å¼æ£€æŸ¥é€»è¾‘ (æ ¸å¿ƒä¿®å¤)
		-- ==========================================
		local myPvP = Player:GetAttribute("PvPEnabled")      -- æ”»å‡»è€…(æˆ‘)çš„çŠ¶æ€
		local targetPvP = targetPlayer:GetAttribute("PvPEnabled")  -- å—å‡»è€…(ä»–)çš„çŠ¶æ€

		-- åªæœ‰åŒæ–¹éƒ½å¼€å¯äº† PVPï¼Œæ‰å…è®¸é€ æˆä¼¤å®³
		if not (myPvP and targetPvP) then
			return -- ğŸš« åœæ­¢æ‰§è¡Œï¼Œä¸é€ æˆä¼¤å®³
		end
		-- ==========================================
	end

	-- é€ æˆä¼¤å®³å‰ï¼Œå…ˆæ ‡è®°
	UntagHumanoid(targetHum)
	TagHumanoid(targetHum, Player)

	targetHum:TakeDamage(CurrentDamage)
end

-- ==========================================
-- æ”»å‡»é€»è¾‘
-- ==========================================
function Attack()
	CurrentDamage = SlashDamage
	Sounds.Slash:Play()

	if Humanoid then
		local anim = Instance.new("Animation")
		anim.AnimationId = "rbxassetid://522635514"
		local track = Humanoid:LoadAnimation(anim)
		track:Play()
	end
end

function Lunge()
	CurrentDamage = LungeDamage
	Sounds.Lunge:Play()

	if Humanoid then
		local anim = Instance.new("Animation")
		anim.AnimationId = "rbxassetid://522638767"
		local track = Humanoid:LoadAnimation(anim)
		track:Play()
	end

	-- çªåˆºä½ç§»
	if Character and Character:FindFirstChild("HumanoidRootPart") then
		local bv = Instance.new("BodyVelocity")
		bv.Velocity = Character.HumanoidRootPart.CFrame.LookVector * 50
		bv.MaxForce = Vector3.new(10000, 0, 10000) -- åªæ¨æ°´å¹³æ–¹å‘
		bv.Parent = Character.HumanoidRootPart
		Debris:AddItem(bv, 0.2)
	end

	task.wait(0.5)
	CurrentDamage = SlashDamage
end

-- åŒå‡»åˆ¤å®š
local LastClick = 0

function Activated()
	if not Tool.Enabled or not ToolEquipped then return end
	Tool.Enabled = false

	local now = tick()
	if (now - LastClick < 0.3) then
		Lunge()
		LastClick = 0
	else
		Attack()
		LastClick = now
	end

	task.wait(0.4) -- æ”»é€Ÿ
	Tool.Enabled = true
end

function Equipped()
	Character = Tool.Parent
	Player = Players:GetPlayerFromCharacter(Character)
	Humanoid = Character:FindFirstChild("Humanoid")
	ToolEquipped = true
	Sounds.Unsheath:Play()
end

function Unequipped()
	ToolEquipped = false
end

Tool.Activated:Connect(Activated)
Tool.Equipped:Connect(Equipped)
Tool.Unequipped:Connect(Unequipped)
Handle.Touched:Connect(Blow)