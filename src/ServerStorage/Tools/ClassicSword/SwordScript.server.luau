-- Sword/Bat Script: ç»ˆæä¿®å¤ç‰ˆ
-- (å¤šå®‰å…¨åŒºæ”¯æŒ + PvPæ£€æŸ¥ + é˜²è¯¯è§¦ + ä»»åŠ¡è®¡æ•°)

local Tool = script.Parent
local Handle = Tool:WaitForChild("Handle")
local Players = game:GetService("Players")
local Debris = game:GetService("Debris")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- 1. è·å–é…ç½®
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))
local toolName = Tool.Name
local weaponStats = GameConfig.Weapons[toolName] or GameConfig.Weapons["Bat"] or {Damage = 10}

local BaseDamage = weaponStats.Damage or 10
local SlashDamage = BaseDamage
local LungeDamage = math.floor(BaseDamage * 1.5)
local CurrentDamage = BaseDamage

-- éŸ³æ•ˆ
local BaseUrl = "rbxassetid://"
local function loadSound(name, id)
	local sound = Handle:FindFirstChild(name)
	if not sound then
		sound = Instance.new("Sound")
		sound.Name = name
		sound.SoundId = BaseUrl .. id
		sound.Volume = 0.5
		sound.Parent = Handle
	end
	return sound
end
local Sounds = {
	Slash = loadSound("Slash", "12222216"),
	Lunge = loadSound("Lunge", "12222208"),
	Unsheath = loadSound("Unsheath", "12222225")
}

-- å˜é‡
local ToolEquipped = false
local Character = nil
local Player = nil
local Humanoid = nil
local IsAttacking = false -- æ”»å‡»çŠ¶æ€æ ‡è®°

Tool.Enabled = true

-- ==========================================
-- [æ ¸å¿ƒå‡çº§] å¤šå®‰å…¨åŒºæ£€æµ‹ç³»ç»Ÿ
-- ==========================================
local SafeZoneParts = {} -- ç¼“å­˜æ‰€æœ‰çš„å®‰å…¨åŒºé›¶ä»¶

-- åˆ·æ–°å®‰å…¨åŒºåˆ—è¡¨ (åœ¨è„šæœ¬å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡)
local function refreshSafeZones()
	table.clear(SafeZoneParts)
	-- éå† Workspace ä¸‹çš„æ‰€æœ‰ä¸œè¥¿ï¼Œæ‰¾åˆ°åå­—å« "SafeZone" çš„é›¶ä»¶
	for _, part in pairs(Workspace:GetDescendants()) do
		if part.Name == "SafeZone" and part:IsA("BasePart") then
			table.insert(SafeZoneParts, part)
		end
	end
	-- print("ğŸ›¡ï¸ å·²åŠ è½½ " .. #SafeZoneParts .. " ä¸ªå®‰å…¨åŒº")
end

-- åˆå§‹åŒ–åŠ è½½
refreshSafeZones()

-- æ£€æŸ¥è§’è‰²æ˜¯å¦åœ¨ã€ä»»æ„ä¸€ä¸ªã€‘å®‰å…¨åŒºå†…
local function isInSafeZone(char)
	local rootPart = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso")
	if not rootPart then return false end

	-- åªéœ€è¦éå†ç¼“å­˜çš„åˆ—è¡¨ï¼Œæ€§èƒ½æé«˜
	for _, zonePart in pairs(SafeZoneParts) do
		-- ç¡®ä¿é›¶ä»¶è¿˜åœ¨(æ²¡è¢«åˆ æ‰)
		if zonePart and zonePart.Parent then
			local partsInZone = Workspace:GetPartsInPart(zonePart)
			for _, part in pairs(partsInZone) do
				if part == rootPart then
					return true -- åªè¦åœ¨ä¸€ä¸ªåœˆé‡Œï¼Œå°±ç®—å®‰å…¨
				end
			end
		end
	end
	return false
end
-- ==========================================

function TagHumanoid(humanoid, player)
	local creator_tag = Instance.new("ObjectValue")
	creator_tag.Name = "creator"
	creator_tag.Value = player
	Debris:AddItem(creator_tag, 5) 
	creator_tag.Parent = humanoid
end

function UntagHumanoid(humanoid)
	for i, v in pairs(humanoid:GetChildren()) do
		if v:IsA("ObjectValue") and v.Name == "creator" then
			v:Destroy()
		end
	end
end

function Blow(Hit)
	if not Hit or not Hit.Parent or not ToolEquipped or not Player then return end

	-- 1. [é˜²è¯¯è§¦] å¦‚æœæ²¡æœ‰åœ¨æŒ¥åŠ¨ï¼Œç›´æ¥å¿½ç•¥
	if not IsAttacking then return end

	local targetChar = Hit.Parent
	if targetChar == Character then return end

	local targetHum = targetChar:FindFirstChild("Humanoid")
	if not targetHum or targetHum.Health <= 0 then return end

	-- 2. [å®‰å…¨åŒºæ‹¦æˆª] ä»»æ„ä¸€æ–¹åœ¨å®‰å…¨åŒºï¼Œéƒ½æ— æ•ˆ
	if isInSafeZone(Character) or isInSafeZone(targetChar) then
		return
	end

	-- 3. [PvPæ‹¦æˆª]
	local targetPlayer = Players:GetPlayerFromCharacter(targetChar)
	if targetPlayer then
		if targetPlayer == Player then return end
		if targetPlayer.Team and targetPlayer.Team == Player.Team then return end

		-- åŒæ–¹å¿…é¡»éƒ½å¼€å¯ PvP
		local myPvP = Player:GetAttribute("PvPEnabled")
		local targetPvP = targetPlayer:GetAttribute("PvPEnabled")

		if not (myPvP and targetPvP) then
			return 
		end
	end

	-- é€ æˆä¼¤å®³
	UntagHumanoid(targetHum)
	TagHumanoid(targetHum, Player)
	targetHum:TakeDamage(CurrentDamage)
end

function Attack()
	IsAttacking = true
	CurrentDamage = SlashDamage
	Sounds.Slash:Play()

	if Humanoid then
		local anim = Instance.new("Animation")
		anim.AnimationId = "rbxassetid://522635514"
		local track = Humanoid:LoadAnimation(anim)
		track:Play()
	end

	task.wait(0.5) -- æŒ¥ç åˆ¤å®šæ—¶é—´
	IsAttacking = false
end

function Lunge()
	IsAttacking = true
	CurrentDamage = LungeDamage
	Sounds.Lunge:Play()

	if Humanoid then
		local anim = Instance.new("Animation")
		anim.AnimationId = "rbxassetid://522638767"
		local track = Humanoid:LoadAnimation(anim)
		track:Play()
	end

	if Character and Character:FindFirstChild("HumanoidRootPart") then
		local bv = Instance.new("BodyVelocity")
		bv.Velocity = Character.HumanoidRootPart.CFrame.LookVector * 50
		bv.MaxForce = Vector3.new(10000, 0, 10000)
		bv.Parent = Character.HumanoidRootPart
		Debris:AddItem(bv, 0.2)
	end

	task.wait(0.5)
	CurrentDamage = SlashDamage
	IsAttacking = false
end

local LastClick = 0

function Activated()
	if not Tool.Enabled or not ToolEquipped then return end
	Tool.Enabled = false

	local now = tick()
	if (now - LastClick < 0.3) then
		Lunge()
		LastClick = 0
	else
		Attack()
		LastClick = now
	end

	Tool.Enabled = true
end

function Equipped()
	Character = Tool.Parent
	Player = Players:GetPlayerFromCharacter(Character)
	Humanoid = Character:FindFirstChild("Humanoid")
	ToolEquipped = true
	IsAttacking = false
	Sounds.Unsheath:Play()
end

function Unequipped()
	ToolEquipped = false
	IsAttacking = false
end

Tool.Activated:Connect(Activated)
Tool.Equipped:Connect(Equipped)
Tool.Unequipped:Connect(Unequipped)
Handle.Touched:Connect(Blow)